<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blacfox ‚Ä¢ Star Player</title>
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#0a0a0c; --panel:#111214; --panel2:#0e0f11;
    --ink:#f3f3f4; --muted:#b6b8bd;
    --accent:#ff7a00; --accent-rgb:255,122,0;
    --ok:#35d07f; --warn:#ffd166; --err:#ef476f;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 800px at 10% -10%, rgba(255,122,0,.07), transparent 60%),
      radial-gradient(900px 600px at 110% 10%, rgba(255,122,0,.05), transparent 60%),
      var(--bg);
    color:var(--ink);
    font:15px/1.55 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    letter-spacing:.2px;
  }
  /* terminal scanlines + vignette */
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background:repeating-linear-gradient(180deg, rgba(255,255,255,.02) 0 2px, transparent 2px 4px);
    mix-blend-mode:soft-light; opacity:.6; z-index:0;
  }
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:radial-gradient(75% 75% at 50% 120%, rgba(0,0,0,.7), transparent 60%);
  }

  .wrap{position:relative; z-index:1; min-height:100%; display:flex; flex-direction:column}

  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg, rgba(17,18,20,.95), rgba(17,18,20,.75));
    border-bottom:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(6px);
  }
  .topbar{display:flex; align-items:center; gap:14px; padding:10px 16px; max-width:1100px; margin:0 auto;}
  .brand{display:flex; align-items:center; gap:10px}
  .brand img{height:38px; width:auto; filter:drop-shadow(0 0 12px rgba(var(--accent-rgb),.35))}
  .brand h1{margin:0; font-size:16px; letter-spacing:.8px; text-transform:uppercase}
  .brand h1 .dot{color:var(--accent)}
  .who{margin-left:8px; color:var(--muted); font-size:13px}

  nav{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    appearance:none; border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg,#151618,#0e0f11);
    color:var(--ink); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;
    transition:.15s transform, .2s border-color, .2s box-shadow;
  }
  .btn:hover{transform:translateY(-1px); border-color:rgba(var(--accent-rgb),.6); box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 0 0 1px rgba(var(--accent-rgb),.25)}
  .btn.accent{background:linear-gradient(180deg, rgba(var(--accent-rgb),.95), rgba(var(--accent-rgb),.8)); color:#111; border-color:transparent}
  .btn.ghost{background:transparent}
  .btn.small{padding:6px 9px; font-weight:800}

  main{flex:1; max-width:1100px; margin:18px auto 40px; padding:0 16px}
  .panel{
    background:conic-gradient(from 180deg at 110% -10%, rgba(var(--accent-rgb),.09), transparent 18%) , var(--panel);
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:18px; margin:14px 0; box-shadow:0 12px 30px rgba(0,0,0,.25);
  }
  .panel h2{margin:0 0 10px 0; font-size:18px; letter-spacing:.5px}
  .sub{color:var(--muted); margin-top:-2px; margin-bottom:14px}

  .grid{display:grid; gap:12px}
  @media (min-width:900px){ .grid.cols-2{grid-template-columns:1fr 1fr} }

  input, select, textarea{
    width:100%; background:var(--panel2); color:var(--ink); border:1px solid rgba(255,255,255,.12);
    border-radius:12px; padding:10px 12px; font:inherit; outline:none;
  }
  textarea{min-height:120px; resize:vertical}
  label{display:block; margin:8px 0 6px; color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > *{flex:1}
  .sep{height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent); margin:12px 0}
  .muted{color:var(--muted)}

  .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); font-size:12px}
  .chip.ok{border-color:rgba(53,208,127,.4); color:#bff3d7} .chip.abs{border-color:rgba(239,71,111,.4); color:#ffc5d2}

  /* Bars */
  .bar{height:12px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; outline:1px solid rgba(255,255,255,.08)}
  .bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg, rgba(var(--accent-rgb),1), rgba(var(--accent-rgb),.55)); transition:width .9s cubic-bezier(.2,.9,.2,1.1)}

  /* Phase banner (Team View) */
  .phase{
    display:flex; align-items:center; gap:10px; padding:12px 14px; border:1px dashed rgba(255,255,255,.16);
    border-radius:12px; background:rgba(255,255,255,.03);
  }
  .pill{font-weight:800; padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16)}
  .pill.open{background:rgba(255,122,0,.15); border-color:rgba(var(--accent-rgb),.5); color:#ffd7b3}
  .pill.idle{background:rgba(255,255,255,.07); color:#ddd}
  .pill.closed{background:rgba(53,208,127,.15); color:#c9f3df; border-color:rgba(53,208,127,.45)}

  /* KG mini-panel */
  .md-panel{
    margin-top:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    padding:10px; border-radius:12px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.12)
  }
  .md-panel .stat{padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted); font-weight:800}

  /* Overlay: identity + drumroll */
  .overlay{
    position:fixed; inset:0; background:radial-gradient(120% 120% at 50% -10%, rgba(255,122,0,.15), transparent 50%), rgba(0,0,0,.88);
    z-index:5000; display:none; align-items:center; justify-content:center; flex-direction:column; gap:14px;
    text-align:center; backdrop-filter: blur(2px); padding:16px;
  }
  .overlay.active{display:flex;}
  .overlay .box{background:#111214; border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:18px; width:min(420px,90vw); box-shadow:0 20px 40px rgba(0,0,0,.5)}
  .overlay h3{margin:0 0 8px 0}
  .overlay .row{margin-top:10px}

  .drumroll-text{font-size:28px; letter-spacing:3px; color:var(--muted); text-transform:uppercase}
  .countdown{font-size:64px; font-weight:900; letter-spacing:4px}
  .drumroll-bar{width:min(520px, 86vw); height:14px; background:rgba(255,255,255,.1); border-radius:999px; overflow:hidden; outline:1px solid rgba(255,255,255,.15)}
  .drumroll-bar .bar-fill{height:100%; width:0%; background:linear-gradient(90deg, rgba(255,255,255,.35), rgba(var(--accent-rgb),.9)); transition:width 1s linear}
  .winner-reveal{display:flex; flex-direction:column; align-items:center; gap:8px}
  .winner-title{font-size:22px; color:var(--muted); text-transform:uppercase; letter-spacing:3px}
  .winner-name{font-size:36px; font-weight:900; padding:8px 14px; border-radius:12px; background:rgba(255,255,255,.06); outline:1px solid rgba(255,255,255,.15)}
  .confetti{position:fixed; pointer-events:none; z-index:6000; width:8px; height:14px; opacity:.95}

  .note{font-size:12px; color:var(--muted)}
  .hide{display:none !important}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="topbar">
      <div class="brand">
        <img src="logo.png" alt="Blacfox logo" />
        <h1>Blacfox <span class="dot">‚Ä¢</span> Star Player</h1>
        <div class="who" id="whoAmIText"></div>
      </div>
      <nav>
        <button class="btn" data-view="team">Team View</button>
        <button class="btn" data-view="vote">Vote</button>
        <button class="btn ghost hide" id="adminNav" data-view="admin">Admin</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- TEAM VIEW -->
    <section id="view-team" class="panel">
      <h2>Team View</h2>
      <div id="phaseBanner" class="phase">
        <span id="phasePill" class="pill idle">Waiting</span>
        <span id="phaseText" class="muted">Waiting to begin‚Ä¶</span>
      </div>

      <div class="md-panel hide" id="mdPanel">
        <span class="stat">Present: <b id="mdPresent">0</b></span>
        <span class="stat">Votes: <b id="mdVotes">0</b></span>
        <button class="btn small accent hide" id="btnStart">Start Voting</button>
        <button class="btn small accent hide" id="btnReveal">Reveal Winner</button>
      </div>

      <div class="sep"></div>

      <div class="grid cols-2">
        <div class="panel">
          <h3>Attendance</h3>
          <div class="row">
            <div class="chip"><span>üë•</span><span id="t-total">0</span>&nbsp;Total</div>
            <div class="chip ok"><span>üü¢</span><span id="t-present">0</span>&nbsp;Present</div>
            <div class="chip abs"><span>üî¥</span><span id="t-absent">0</span>&nbsp;Absent</div>
            <div class="chip"><span>üó≥Ô∏è</span><span id="t-voted">0</span>&nbsp;Voted</div>
          </div>
          <div class="sep"></div>
          <table class="table" id="teamTable" style="width:100%; border-collapse:separate; border-spacing:0 8px">
            <thead><tr><th>Name</th><th>Initials</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="panel">
          <h3 id="resultsTitle">Results</h3>
          <div id="resultsHint" class="muted">Results are hidden until the winner is revealed.</div>
          <div id="teamBars" class="hide"></div>
        </div>
      </div>
    </section>

    <!-- VOTE -->
    <section id="view-vote" class="panel hide">
      <h2>Vote</h2>
      <div class="sub">You‚Äôll first confirm your identity (once), then pick your Star Player. Self-votes are blocked. KG cannot vote.</div>

      <div class="grid cols-2">
        <div class="panel">
          <h3>Identity</h3>
          <div id="idSummary" class="muted">You are: <b id="idWho"></b></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="changeIdentity">Change identity</button>
          </div>
          <p class="note" style="margin-top:8px">Identity persists on this device.</p>
        </div>

        <div class="panel" id="votePanel">
          <h3>Ballot</h3>
          <div id="voteGuard" class="muted">Confirm your identity to proceed.</div>
          <div id="voteForm" class="hide">
            <label for="voteFor">I vote for</label>
            <select id="voteFor"></select>

            <div class="row" style="margin-top:10px">
              <button class="btn" id="confirmPick">Confirm pick</button>
              <button class="btn" id="editPick" disabled>Change</button>
            </div>

            <div class="row" style="margin-top:8px">
              <button class="btn accent" id="submitVote" disabled>Submit Vote</button>
              <button class="btn" id="clearPick">Clear</button>
            </div>

            <div id="voteMsg" class="muted" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN (only ZS) -->
    <section id="view-admin" class="panel hide">
      <h2>Admin</h2>
      <div class="sub">Team & session controls (visible only when you are ZS).</div>

      <div class="grid cols-2">
        <div class="panel">
          <h3>Team Members</h3>
          <label for="teamArea">Format: <code>Full Name - XX</code> per line</label>
          <textarea id="teamArea" spellcheck="false"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn accent" id="saveTeam">Save Team</button>
            <button class="btn" id="resetSession">New Session</button>
          </div>
          <p class="note" style="margin-top:8px">Changes save to this device (localStorage).</p>
        </div>

        <div class="panel">
          <h3>Attendance</h3>
          <div id="adminAttendance"></div>
          <div id="adminMsg" class="muted" style="margin-top:10px"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Identity modal (blocking on first load) -->
<div class="overlay" id="identityModal" aria-hidden="true">
  <div class="box">
    <h3>Confirm your identity</h3>
    <label for="idModalSelect">Choose your initials</label>
    <select id="idModalSelect"></select>
    <div class="row">
      <button class="btn accent" id="idModalConfirm">Confirm identity</button>
    </div>
    <p class="note" style="margin-top:8px">You only need to do this once per device.</p>
  </div>
</div>

<!-- Reveal overlay (created dynamically when used) -->

<script>
/* =========================
   Data & Storage
========================= */
const LS = {
  team:'bf_team',
  votes:'bf_votes',
  voted:'bf_voted_by',
  user:'bf_current_user',
  phase:'bf_phase' // 'not_started' | 'open' | 'revealed'
};

// Default team
const DEFAULT_MEMBERS = [
  {name:'Olwethu',     initials:'OB', status:'absent'},
  {name:'Christopher', initials:'CB', status:'absent'},
  {name:'Malaika',     initials:'MR', status:'absent'},
  {name:'Amilio',      initials:'AB', status:'absent'},
  {name:'Zubair',      initials:'ZS', status:'absent'},
  {name:'Amjad',       initials:'AZ', status:'absent'},
  {name:'Jerome',      initials:'JM', status:'absent'},
  {name:'Emilio',      initials:'ED', status:'absent'},
  {name:'Benita',      initials:'BJ', status:'absent'},
  {name:'Jaydon',      initials:'JV', status:'absent'},
  {name:'Stehpan',     initials:'SE', status:'absent'},
  {name:'Kerushan',    initials:'KG', status:'absent'},
  {name:'Payal',       initials:'PS', status:'absent'},
  {name:'Yudhveer',    initials:'YM', status:'absent'},
  {name:'Rinolan',     initials:'RR', status:'absent'},
  {name:'Fhad',        initials:'FW', status:'absent'},
  {name:'Brendon',     initials:'BS', status:'absent'},
];

function loadTeam(){
  const raw = localStorage.getItem(LS.team);
  let team = raw ? JSON.parse(raw) : DEFAULT_MEMBERS.slice();
  return team.map(t=>({name:String(t.name), initials:String(t.initials).toUpperCase(), status:t.status==='present'?'present':'absent'}));
}
function saveTeam(t){ localStorage.setItem(LS.team, JSON.stringify(t)); }

function loadVotes(){ return JSON.parse(localStorage.getItem(LS.votes)||'{}'); }
function saveVotes(v){ localStorage.setItem(LS.votes, JSON.stringify(v)); }
function loadVoted(){ return JSON.parse(localStorage.getItem(LS.voted)||'[]'); }
function saveVoted(a){ localStorage.setItem(LS.voted, JSON.stringify(a)); }
function getUser(){ return localStorage.getItem(LS.user) || ''; }
function setUser(i){ if(i) localStorage.setItem(LS.user, i); else localStorage.removeItem(LS.user); updateNav(); }
function getPhase(){ return localStorage.getItem(LS.phase) || 'not_started'; }
function setPhase(p){ localStorage.setItem(LS.phase, p); renderPhase(); renderTeam(); renderMd(); renderVote(); }

/* =========================
   State
========================= */
let teamMembers = loadTeam();     // [{name,initials,status}]
let votes = loadVotes();          // {initials: count}
let votedInitials = loadVoted();  // ["JV","KG",...]
let selectedPick = '';            // current ballot selection (initials)
let pickConfirmed = false;        // two-step confirm flag

/* =========================
   Utilities
========================= */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function showView(id){
  $$('main > section').forEach(s=>s.classList.add('hide'));
  $('#view-'+id).classList.remove('hide');
  if(id==='team'){ renderTeam(); renderMd(); }
  if(id==='vote'){ renderVote(); }
  if(id==='admin'){ renderAdmin(); }
}
function resultsData(){
  return teamMembers
    .map(m=>({ name:m.name, initials:m.initials, votes: Number(votes[m.initials]||0) }))
    .sort((a,b)=>b.votes - a.votes || a.name.localeCompare(b.name));
}
function tallies(){
  const total   = teamMembers.length;
  const present = teamMembers.filter(m=>m.status==='present').length;
  const absent  = total - present;
  const voted   = new Set(votedInitials).size;
  return {total, present, absent, voted};
}
function updateNav(){
  const u = getUser();
  const rec = teamMembers.find(x=>x.initials===u);
  $('#whoAmIText').textContent = u ? `You are: ${rec?rec.name:u}` : '';
  // Admin nav only if ZS
  $('#adminNav').classList.toggle('hide', u!=='ZS');
}

/* =========================
   TEAM VIEW
========================= */
function renderPhase(){
  const phase = getPhase();
  const pill = $('#phasePill');
  const text = $('#phaseText');
  if(phase==='not_started'){
    pill.className='pill idle'; pill.textContent='Waiting';
    text.textContent='Waiting to begin‚Ä¶';
  }else if(phase==='open'){
    pill.className='pill open'; pill.textContent='Voting';
    text.textContent='Voting still in progress';
  }else{
    pill.className='pill closed'; pill.textContent='Closed';
    text.textContent='Winner revealed';
  }
  const revealed = phase==='revealed';
  $('#resultsHint').classList.toggle('hide', revealed);
  $('#teamBars').classList.toggle('hide', !revealed);
  $('#resultsTitle').textContent = revealed ? 'Results' : 'Results (hidden)';
}

function renderTeam(){
  const {total, present, absent, voted} = tallies();
  $('#t-total').textContent = total;
  $('#t-present').textContent = present;
  $('#t-absent').textContent = absent;
  $('#t-voted').textContent = voted;

  // table
  const tb = $('#teamTable tbody');
  tb.innerHTML = teamMembers.map(m=>{
    const chip = m.status==='present' ? '<span class="chip ok">Present</span>' : '<span class="chip abs">Absent</span>';
    return `<tr>
      <td>${m.name}</td>
      <td><strong>${m.initials}</strong></td>
      <td>${chip}</td>
    </tr>`;
  }).join('');

  // bars (only after reveal)
  const bars = $('#teamBars');
  const data = resultsData();
  const max = Math.max(1, ...data.map(d=>d.votes));
  bars.innerHTML = data.map(d=>{
    const pct = Math.round((d.votes/max)*100);
    return `<div style="margin:10px 0">
      <div class="row" style="align-items:center">
        <div style="font-weight:800;">${d.name} <span class="muted">(${d.initials})</span></div>
        <div style="margin-left:auto" class="chip">${d.votes} vote${d.votes===1?'':'s'}</div>
      </div>
      <div class="bar"><span style="width:${pct}%"></span></div>
    </div>`;
  }).join('');
}

function renderMd(){
  const u = getUser();
  const isKG = u==='KG';
  const panel = $('#mdPanel');
  panel.classList.toggle('hide', !isKG);
  if(!isKG) return;

  const {present, voted} = tallies();
  $('#mdPresent').textContent = present;
  $('#mdVotes').textContent = voted;

  const phase = getPhase();
  $('#btnStart').classList.toggle('hide', phase!=='not_started');
  $('#btnReveal').classList.toggle('hide', phase!=='open');
}

/* Start + Reveal (KG only) */
function mdStartVoting(){ setPhase('open'); }
function mdReveal(){
  setPhase('revealed'); // lock immediately
  revealOverlay();
}

/* 10s drum-roll overlay */
function revealOverlay(){
  const data = resultsData();
  const top = Math.max(0, ...data.map(d=>d.votes));
  if(top===0){
    const overlay = document.createElement('div');
    overlay.className='overlay active';
    overlay.innerHTML = `<div class="box"><div class="winner-reveal"><div class="winner-title">No votes cast</div></div></div>`;
    document.body.appendChild(overlay);
    setTimeout(()=>overlay.remove(), 2000);
    return;
  }
  const winners = data.filter(d=>d.votes===top);
  const overlay = document.createElement('div');
  overlay.className = 'overlay active';
  overlay.innerHTML = `
    <div class="box" style="text-align:center">
      <div class="drumroll-text">Drum roll‚Ä¶</div>
      <div class="countdown" id="dr-count">10</div>
      <div class="drumroll-bar"><div class="bar-fill" id="dr-fill"></div></div>
    </div>
  `;
  document.body.appendChild(overlay);

  let remain = 10;
  const num = overlay.querySelector('#dr-count');
  const fill = overlay.querySelector('#dr-fill');
  fill.style.width = '0%';

  const tick = setInterval(()=>{
    remain -= 1;
    num.textContent = remain;
    fill.style.width = `${(10 - remain) * 10}%`;
    if(remain <= 0){
      clearInterval(tick);
      overlay.innerHTML = `
        <div class="box" style="text-align:center">
          <div class="winner-reveal">
            <div class="winner-title">Star Player</div>
            <div class="winner-name">${winners.map(w=>w.name).join(' & ')}</div>
          </div>
        </div>
      `;
      for(let i=0;i<150;i++) spawnConfetti();
      setTimeout(()=>overlay.remove(), 6000);
    }
  },1000);
}
function spawnConfetti(){
  const el = document.createElement('div');
  el.className='confetti';
  const colors = ['#ffffff','#ffe8cc','#ffb26a','#ff7a00','#ffd166'];
  const left = Math.random()*100;
  const size = 6 + Math.random()*8;
  const rot = Math.random()*360;
  const dur = 3 + Math.random()*2;
  el.style.left = left+'vw';
  el.style.top = '-20px';
  el.style.width = size+'px';
  el.style.height = (size*1.4)+'px';
  el.style.background = colors[Math.floor(Math.random()*colors.length)];
  el.style.transform = `rotate(${rot}deg)`;
  el.style.opacity = .95;
  el.style.position = 'fixed';
  el.style.zIndex = 6000;
  el.style.transition = `transform ${dur}s cubic-bezier(.2,.9,.2,1.05), top ${dur}s cubic-bezier(.2,.9,.2,1.05), opacity ${dur}s linear`;
  document.body.appendChild(el);
  requestAnimationFrame(()=>{
    el.style.top = '110vh';
    el.style.transform = `translateX(${(Math.random()*2-1)*120}px) rotate(${rot + 600}deg)`;
    el.style.opacity = .1;
  });
  setTimeout(()=> el.remove(), dur*1000+500);
}

/* =========================
   VOTE (two-step)
========================= */
function renderVote(){
  const u = getUser();
  const rec = teamMembers.find(x=>x.initials===u);
  $('#idWho').textContent = rec ? `${rec.name} (${rec.initials})` : '‚Äî';
  $('#voteGuard').classList.toggle('hide', !!u);
  $('#voteForm').classList.toggle('hide', !u);

  // KG cannot vote
  if(u==='KG'){
    $('#voteGuard').textContent = 'Hi KG. You cannot vote. Use Team View to start and reveal.';
    $('#voteForm').classList.add('hide');
    return;
  }

  // Phase guards
  const phase = getPhase();
  if(!u){ $('#voteGuard').textContent = 'Confirm your identity to proceed.'; return; }
  if(phase==='not_started'){ $('#voteGuard').textContent = 'Voting has not started yet.'; return; }
  if(phase==='revealed'){ $('#voteGuard').textContent = 'Voting is closed.'; return; }

  // If user already voted
  const msg = $('#voteMsg');
  if(votedInitials.includes(u)){
    $('#voteForm').classList.add('hide');
    $('#voteGuard').classList.remove('hide');
    $('#voteGuard').textContent = 'You have already voted.';
    return;
  } else {
    $('#voteGuard').classList.add('hide');
    $('#voteForm').classList.remove('hide');
  }

  // Build ballot: everyone except self (no presence filter)
  const ballot = teamMembers.filter(m=>m.initials!==u);
  const sel = $('#voteFor');
  sel.innerHTML = '<option value="">Select a teammate‚Ä¶</option>' +
    ballot.map(m=>`<option value="${m.initials}">${m.name} ‚Äî ${m.initials}</option>`).join('');
  // restore selection / lock state
  sel.value = selectedPick || '';
  sel.disabled = pickConfirmed;

  // Buttons
  $('#confirmPick').disabled = !sel.value || pickConfirmed;
  $('#editPick').disabled = !pickConfirmed;
  $('#submitVote').disabled = !pickConfirmed;
  msg.textContent = pickConfirmed && sel.value ? `Confirming vote for ${ballot.find(x=>x.initials===sel.value)?.name || sel.value}.` : '';
}

function onPickChange(){
  selectedPick = $('#voteFor').value.trim().toUpperCase();
  pickConfirmed = false;
  renderVote();
}
function confirmPick(){
  if(!selectedPick){ return; }
  pickConfirmed = true;
  renderVote();
}
function editPick(){
  pickConfirmed = false;
  renderVote();
}
function clearPick(){
  selectedPick = '';
  pickConfirmed = false;
  $('#voteMsg').textContent = '';
  renderVote();
}

function voteSubmit(){
  const u = getUser();
  const msg = $('#voteMsg');
  if(!u){ msg.textContent='Confirm identity first.'; return; }
  if(u==='KG'){ msg.textContent='KG does not vote.'; return; }
  if(getPhase()!=='open'){ msg.textContent='Voting is not open.'; return; }
  if(votedInitials.includes(u)){ msg.textContent='You have already voted.'; return; }
  if(!pickConfirmed || !selectedPick){ msg.textContent='Confirm your pick first.'; return; }
  if(selectedPick===u){ msg.textContent='Self-votes are not allowed.'; return; }

  // Record anonymous vote for the chosen initials
  votes[selectedPick] = (votes[selectedPick]||0) + 1;
  votedInitials.push(u);
  saveVotes(votes); saveVoted(votedInitials);

  // Reset local state
  selectedPick = ''; pickConfirmed = false;

  msg.textContent = 'Vote recorded. Thank you!';
  renderTeam(); renderMd(); renderVote();
}

/* =========================
   ADMIN (ZS only)
========================= */
function renderAdmin(){
  const u = getUser();
  const allowed = (u==='ZS');
  if(!allowed){
    $('#view-admin').innerHTML = `<div class="panel"><h2>Admin</h2><p class="muted">Access denied. This section is visible only when the confirmed user is ZS.</p></div>`;
    return;
  }
  // textarea
  $('#teamArea').value = teamMembers.map(m=>`${m.name} - ${m.initials}`).join('\n');

  // attendance controls
  const tgt = $('#adminAttendance');
  tgt.innerHTML = teamMembers.map((m,idx)=>{
    const checked = m.status==='present' ? 'checked' : '';
    return `<label style="display:flex;align-items:center;gap:10px;margin:6px 0">
      <input type="checkbox" data-i="${idx}" ${checked}/> ${m.name} <span class="muted">(${m.initials})</span>
    </label>`;
  }).join('');
  tgt.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const i = Number(e.target.getAttribute('data-i'));
      teamMembers[i].status = e.target.checked ? 'present' : 'absent';
      saveTeam(teamMembers);
      $('#adminMsg').textContent = 'Attendance updated.';
      renderTeam(); renderVote(); renderMd();
    });
  });
}

function saveTeamFromArea(){
  const lines = $('#teamArea').value.split('\n').map(x=>x.trim()).filter(Boolean);
  const arr = [];
  for(const line of lines){
    const m = line.match(/^(.+?)\s*-\s*([A-Za-z]{1,4})$/);
    if(!m) continue;
    arr.push({name:m[1].trim(), initials:m[2].toUpperCase(), status:'absent'});
  }
  if(!arr.length){ alert('No valid lines. Use "Full Name - XX"'); return; }
  teamMembers = arr;
  saveTeam(teamMembers);
  votes = {}; votedInitials = [];
  saveVotes(votes); saveVoted(votedInitials);
  $('#adminMsg').textContent = 'Team saved. Session reset.';
  renderTeam(); renderVote(); renderMd(); renderPhase();
}

function newSession(){
  if(!confirm('Start a new session? This clears votes & who voted.')) return;
  votes = {}; votedInitials = [];
  saveVotes(votes); saveVoted(votedInitials);
  setPhase('not_started');
  $('#adminMsg').textContent = 'Session cleared.';
  renderTeam(); renderVote(); renderMd(); renderPhase();
}

/* =========================
   Identity modal
========================= */
function openIdentityModal(){
  const modal = $('#identityModal');
  const sel = $('#idModalSelect');
  sel.innerHTML = '<option value="">Select your initials‚Ä¶</option>' +
    teamMembers.map(m=>`<option value="${m.initials}">${m.name} ‚Äî ${m.initials}</option>`).join('');
  modal.classList.add('active');
}
function closeIdentityModal(){ $('#identityModal').classList.remove('active'); }
function confirmIdentityFromModal(){
  const val = $('#idModalSelect').value.trim().toUpperCase();
  if(!val) return;

  // Mark present
  const rec = teamMembers.find(t=>t.initials===val);
  if(!rec) return;
  rec.status = 'present';
  saveTeam(teamMembers);

  setUser(val);
  closeIdentityModal();
  renderTeam(); renderMd(); renderVote(); renderPhase();
}

/* =========================
   Events & Init
========================= */
$$('nav .btn[data-view]').forEach(b=> b.addEventListener('click', e=> showView(e.target.getAttribute('data-view'))));
// KG controls
$('#btnStart').addEventListener('click', mdStartVoting);
$('#btnReveal').addEventListener('click', mdReveal);

// Vote
$('#voteFor').addEventListener('change', onPickChange);
$('#confirmPick').addEventListener('click', confirmPick);
$('#editPick').addEventListener('click', editPick);
$('#submitVote').addEventListener('click', voteSubmit);
$('#clearPick').addEventListener('click', clearPick);
$('#changeIdentity').addEventListener('click', openIdentityModal);

// Admin nav depends on identity (handled in updateNav)
$('#adminNav').addEventListener('click', ()=> showView('admin'));

// Admin actions
$('#saveTeam').addEventListener('click', saveTeamFromArea);
$('#resetSession').addEventListener('click', newSession);

// Identity modal
$('#idModalConfirm').addEventListener('click', confirmIdentityFromModal);

(function init(){
  // persist structures
  saveTeam(teamMembers); saveVotes(votes); saveVoted(votedInitials);
  updateNav();
  renderPhase();
  renderTeam();
  renderMd();
  renderVote();
  showView('team'); // TV by default

  // Block until identity set
  if(!getUser()) openIdentityModal();
})();
</script>
</body>
</html>
