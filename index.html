<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blacfox • Star Player</title>
<meta name="color-scheme" content="dark" />
<meta name="theme-color" content="#ff7a00">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="logo.png" />

<!-- Social share -->
<meta property="og:title" content="Blacfox • Star Player" />
<meta property="og:description" content="Vote, reveal, celebrate: the Blacfox Star Player mini-app." />
<meta property="og:type" content="website" />
<meta property="og:image" content="logo.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Blacfox • Star Player" />
<meta name="twitter:description" content="Vote, reveal, celebrate: the Blacfox Star Player mini-app." />
<meta name="twitter:image" content="logo.png" />

<!-- Firebase (compat builds, simplest for a single file) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#0a0a0c; --panel:#111214; --panel2:#0e0f11;
    --ink:#f0f0f2; --muted:#b6b8bd;
    --accent:#ff7a00; --accent-rgb:255,122,0;
    --ok:#35d07f; --warn:#ffd166; --err:#ef476f;
    --gx:50%; --gy:50%;
  }
  /* Theme presets */
  :root[data-theme="terminal"]{ /* default */ }
  :root[data-theme="neon"]{
    --bg:#030309; --panel:#0b0c12; --panel2:#07070c;
    --ink:#f7f7ff; --muted:#bdbfe6; --accent:#ff3df0; --accent-rgb:255,61,240;
  }
  :root[data-theme="minimal"]{
    --bg:#0b0b0b; --panel:#121212; --panel2:#0e0e0e;
    --ink:#eeeeee; --muted:#bfbfbf; --accent:#ff8a3d; --accent-rgb:255,138,61;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 800px at 10% -10%, rgba(255,122,0,.07), transparent 60%),
      radial-gradient(900px 600px at 110% 10%, rgba(255,122,0,.05), transparent 60%),
      var(--bg);
    color:var(--ink);
    font:15px/1.55 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    letter-spacing:.2px;
  }
  /* scanlines + vignette */
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background:repeating-linear-gradient(180deg, rgba(255,255,255,.02) 0 2px, transparent 2px 4px);
    mix-blend-mode:soft-light; opacity:.6; z-index:0;
  }
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:radial-gradient(75% 75% at 50% 120%, rgba(0,0,0,.7), transparent 60%);
  }

  /* 5s Terminal loading screen */
  .boot{position:fixed; inset:0; z-index:10000; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:16px; background:#000; color:#fff}
  .glitch{ position:relative; font:700 22px/1 ui-monospace }
  .glitch::before,.glitch::after{content:attr(data-text); position:absolute; left:0; top:0}
  .glitch::before{ color:#ff7a00; transform:translate(2px,0) }
  .glitch::after{ color:#00ffd5; transform:translate(-2px,0) }
  .spinner{ width:36px; height:36px; border-radius:50%; border:3px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin 1s linear infinite }
  @keyframes spin{to{transform:rotate(360deg)}}
  .boot.hide{animation:fadeOut .35s ease forwards}
  @keyframes fadeOut{to{opacity:0; visibility:hidden}}

  /* Floating particles */
  .particles{position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden}
  .particle{ position:absolute; width:4px; height:4px; border-radius:50%; background:rgba(255,255,255,.8); opacity:.6; filter:blur(.2px); animation:floatUp linear infinite }
  .particle.o{ background:rgba(var(--accent-rgb),.9); }
  @keyframes floatUp{ from{ transform:translate3d(var(--x,0), 110vh,0) scale(var(--s,1)); opacity:.0 } 10%{opacity:.6} to{ transform:translate3d(calc(var(--x,0) + var(--dx,0px)), -10vh,0) scale(var(--s,1)); opacity:0 } }

  .wrap{position:relative; z-index:1; min-height:100%; display:flex; flex-direction:column}

  header{
    position:sticky; top:0; z-index:10;
    background:linear-gradient(180deg, rgba(17,18,20,.95), rgba(17,18,20,.75));
    border-bottom:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(6px);
    transition:transform .25s, opacity .25s;
  }
  header.autohide{ transform:translateY(-100%); opacity:0; }

  .topbar{display:flex; align-items:center; gap:14px; padding:10px 16px; max-width:1100px; margin:0 auto;}
  .brand{display:flex; align-items:center; gap:10px}
  .brand img{height:38px; width:auto; filter:drop-shadow(0 0 12px rgba(var(--accent-rgb),.35))}
  .brand h1{margin:0; font-size:16px; letter-spacing:.8px; text-transform:uppercase}
  .brand h1 .dot{color:var(--accent)}
  .who{margin-left:8px; color:var(--muted); font-size:13px}
  .who a{color:var(--muted); text-decoration:underline dotted; cursor:pointer}
  .caret{animation:blink 1.1s steps(1,end) infinite}
  @keyframes blink{50%{opacity:0}}

  nav{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    appearance:none; border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg,#151618,#0e0f11);
    color:var(--ink); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;
    transition:.15s transform, .2s border-color, .2s box-shadow;
  }
  .btn:hover{transform:translateY(-1px); border-color:rgba(var(--accent-rgb),.6); box-shadow:0 6px 16px rgba(0,0,0,.35), inset 0 0 0 1px rgba(var(--accent-rgb),.25)}
  .btn.accent{background:linear-gradient(180deg, rgba(var(--accent-rgb),.95), rgba(var(--accent-rgb),.8)); color:#111; border-color:transparent}
  .btn.ghost{background:transparent}
  .btn.small{padding:6px 9px; font-weight:800}

  main{flex:1; max-width:1100px; margin:18px auto 40px; padding:0 16px}
  .panel{
    background:
      radial-gradient(250px 180px at var(--gx) var(--gy), rgba(var(--accent-rgb),.06), transparent 60%),
      conic-gradient(from 180deg at 110% -10%, rgba(var(--accent-rgb),.09), transparent 18%),
      var(--panel);
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:18px; margin:14px 0; box-shadow:0 12px 30px rgba(0,0,0,.25);
    transition:box-shadow .2s;
  }
  .panel:hover{ box-shadow:0 14px 34px rgba(0,0,0,.35), 0 0 0 1px rgba(var(--accent-rgb),.18) inset; }
  .panel h2{margin:0 0 10px 0; font-size:18px; letter-spacing:.5px}
  .sub{color:var(--muted); margin-top:-2px; margin-bottom:14px}

  .grid{display:grid; gap:12px}
  @media (min-width:900px){ .grid.cols-2{grid-template-columns:1fr 1fr} }

  input, select, textarea{
    width:100%; background:var(--panel2); color:var(--ink); border:1px solid rgba(255,255,255,.12);
    border-radius:12px; padding:10px 12px; font:inherit; outline:none;
  }
  textarea{min-height:120px; resize:vertical}
  label{display:block; margin:8px 0 6px; color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > *{flex:1}

  /* Animated separators */
  .sep{height:2px; border-radius:999px; margin:12px 0; background:
    linear-gradient(90deg, rgba(255,255,255,.0), rgba(var(--accent-rgb),.35), rgba(255,255,255,.0));
    background-size:200% 100%; animation:sepSweep 3s linear infinite; }
  @keyframes sepSweep{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

  .muted{color:var(--muted)}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); font-size:12px}
  .chip.ok{border-color:rgba(53,208,127,.4); color:#bff3d7} .chip.abs{border-color:rgba(239,71,111,.4); color:#ffc5d2}

  .bar{height:12px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; outline:1px solid rgba(255,255,255,.08)}
  .bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg, rgba(var(--accent-rgb),1), rgba(var(--accent-rgb),.55)); transition:width .9s cubic-bezier(.2,.9,.2,1.1)}

  .phase{display:flex; align-items:center; gap:10px; padding:12px 14px; border:1px dashed rgba(255,255,255,.16); border-radius:12px; background:rgba(255,255,255,.03)}
  .pill{font-weight:800; padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16)}
  .pill.open{background:rgba(255,122,0,.15); border-color:rgba(var(--accent-rgb),.5); color:#ffd7b3; animation:pulse 1.2s infinite}
  .pill.idle{background:rgba(255,255,255,.07); color:#ddd}
  .pill.closed{background:rgba(53,208,127,.15); color:#c9f3df; border-color:rgba(53,208,127,.45)}
  #phaseText.typing::after{content:"…"; animation:ellipsis 1.2s infinite}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
  @keyframes ellipsis{0%{content:"."}33%{content:".."}66%{content:"..."}100%{content:"."}}

  .md-panel{margin-top:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; padding:10px; border-radius:12px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.12)}
  .md-panel .stat{padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted); font-weight:800}

  .qrbox{ position:absolute; right:16px; top:56px; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px; z-index:2; transition:opacity .4s }
  .qrbox.fade{ opacity:0; }

  .drumroll{position:fixed; inset:0; background:radial-gradient(120% 120% at 50% -10%, rgba(255,122,0,.15), transparent 50%), rgba(0,0,0,.9); z-index:5000; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:14px; text-align:center; backdrop-filter: blur(2px)}
  .drumroll-text{font-size:28px; letter-spacing:3px; color:var(--muted); text-transform:uppercase}
  .countdown{font-size:64px; font-weight:900; letter-spacing:4px}
  .drumroll-bar{width:min(520px, 86vw); height:14px; background:rgba(255,255,255,.1); border-radius:999px; overflow:hidden; outline:1px solid rgba(255,255,255,.15)}
  .drumroll-bar .bar-fill{height:100%; width:0%; background:linear-gradient(90deg, rgba(255,255,255,.35), rgba(var(--accent-rgb),.9)); transition:width 1s linear}
  .winner-reveal{display:flex; flex-direction:column; align-items:center; gap:8px}
  .winner-title{font-size:22px; color:var(--muted); text-transform:uppercase; letter-spacing:3px}
  .winner-name{font-size:36px; font-weight:900; padding:8px 14px; border-radius:12px; background:rgba(255,255,255,.06); outline:1px solid rgba(255,255,255,.15)}
  .co{ color:#ffd166; font-weight:800; letter-spacing:2px; text-transform:uppercase; }

  .confetti{position:fixed; pointer-events:none; z-index:6000; width:8px; height:14px; opacity:.95}

  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.75); z-index:4500; backdrop-filter:blur(2px)}
  .modal.active{display:flex}
  .modal-card{background:#111; border:1px solid rgba(var(--accent-rgb),.35); border-radius:14px; width:min(440px,92vw); padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .modal-title{margin:0 0 10px 0; font-size:18px; color:var(--accent)}
  .modal-actions{display:flex; gap:10px; margin-top:10px}

  .hide{display:none !important}
</style>
</head>
<body>
<!-- 5s Terminal boot screen with spinner -->
<div class="boot" id="boot">
  <div class="glitch" data-text="Blacfox Terminal">Blacfox Terminal</div>
  <div class="spinner" aria-label="Loading"></div>
  <div style="font:12px ui-monospace; opacity:.7">initializing session…</div>
</div>

<!-- Floating particles -->
<div class="particles" id="particles"></div>

<div class="wrap" aria-live="polite">
  <header id="appHeader">
    <div class="topbar">
      <div class="brand">
        <img src="logo.png" alt="Blacfox logo" />
        <h1>Blacfox <span class="dot">•</span> Star Player <span class="caret">_</span></h1>
        <div class="who" id="whoAmIText"></div>
      </div>
      <nav>
        <button class="btn" data-view="team">Team View</button>
        <button class="btn" data-view="vote">Vote</button>
        <button class="btn ghost hide" id="adminNav" data-view="admin">Admin</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- TEAM VIEW -->
    <section id="view-team" class="panel" onmousemove="setGlow(event)">
      <div class="row" style="justify-content:flex-end; gap:8px; margin-top:-4px">
        <button class="btn small" id="fsToggle">Full Screen</button>
      </div>

      <h2>Team View <span class="caret">_</span></h2>

      <!-- QR to Vote (includes session code) -->
      <div class="qrbox" id="qrBox">
        <div id="qr"></div>
        <div class="muted" style="font-size:12px;margin-top:6px;text-align:center">Scan to vote</div>
      </div>

      <div id="phaseBanner" class="phase">
        <span id="phasePill" class="pill idle">Waiting</span>
        <span id="phaseText" class="muted">Waiting to begin…</span>
      </div>

      <div class="md-panel hide" id="mdPanel">
        <span class="stat">Present: <b id="mdPresent">0</b></span>
        <span class="stat">Votes: <b id="mdVotes">0</b></span>
        <button class="btn small accent hide" id="btnStart">Start Voting</button>
        <button class="btn small accent hide" id="btnReveal">Reveal Winner</button>
        <button class="btn small accent hide" id="btnCloseReveal">Close & Reveal Now</button>
        <!-- PIN controls (KG only) -->
        <span id="pinPanel" class="hide" style="display:flex; align-items:center; gap:8px;">
          <label class="muted" style="display:flex; align-items:center; gap:6px">
            <input type="checkbox" id="pinEnable" /> Require PIN
          </label>
          <button class="btn small" id="pinGenerate">New PIN</button>
          <span class="chip" id="pinValue" title="Share this PIN with voters"></span>
        </span>
      </div>

      <div class="sep"></div>

      <div class="grid cols-2">
        <div class="panel" onmousemove="setGlow(event)">
          <h3>Attendance <span class="caret">_</span></h3>
          <div class="row">
            <div class="chip"><span>👥</span><span id="t-total">0</span>&nbsp;Total</div>
            <div class="chip ok"><span>🟢</span><span id="t-present">0</span>&nbsp;Present</div>
            <div class="chip abs"><span>🔴</span><span id="t-absent">0</span>&nbsp;Absent</div>
            <div class="chip"><span>🗳️</span><span id="t-voted">0</span>&nbsp;Voted</div>
          </div>
          <div class="sep"></div>
          <table class="table" id="teamTable" style="width:100%; border-collapse:separate; border-spacing:0 8px">
            <thead><tr><th>Name</th><th>Initials</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="panel" onmousemove="setGlow(event)">
          <h3 id="resultsTitle">Results <span class="caret">_</span></h3>
          <div id="resultsHint" class="muted">Results are hidden until the winner is revealed.</div>
          <div id="teamBars" class="hide"></div>
        </div>
      </div>
    </section>

    <!-- VOTE -->
    <section id="view-vote" class="panel hide" onmousemove="setGlow(event)">
      <h2>Vote <span class="caret">_</span></h2>
      <div class="sub">Confirm identity once (per browser tab). Then pick a teammate (not yourself), <strong>Confirm</strong> the choice, and <strong>Submit</strong>.</div>

      <div class="grid cols-2">
        <div class="panel" onmousemove="setGlow(event)">
          <h3>Identity</h3>
          <div id="idStatus" class="muted">Not set</div>
          <div class="row" style="margin-top:10px">
            <button class="btn accent" id="openIdentity">Confirm identity</button>
            <button class="btn" id="clearIdentity">Clear</button>
          </div>
        </div>

        <div class="panel" id="votePanel" onmousemove="setGlow(event)">
          <h3>Ballot</h3>
          <div id="voteGuard" class="muted">Confirm your identity to proceed.</div>
          <div id="voteForm" class="hide">
            <label for="voteFor">I vote for</label>
            <select id="voteFor"></select>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="confirmVote">Confirm selection</button>
              <button class="btn accent" id="submitVote" disabled>Submit vote</button>
            </div>
            <div id="voteMsg" class="muted" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN (ZS only) -->
    <section id="view-admin" class="panel hide" onmousemove="setGlow(event)">
      <h2>Admin <span class="caret">_</span></h2>
      <div class="sub">Visible only when you’re <strong>ZS</strong>.</div>

      <div class="grid cols-2">
        <div class="panel" onmousemove="setGlow(event)">
          <h3>Team Members</h3>
          <label for="teamArea">Format: <code>Full Name - XX</code> per line</label>
          <textarea id="teamArea" spellcheck="false"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn accent" id="saveTeam">Save Team</button>
            <button class="btn" id="resetSession">New Day</button>
          </div>
          <p class="muted" style="margin-top:8px">Saves to the session (realtime sync) and locally for offline.</p>

          <div class="sep"></div>
          <label for="themeSelect">Theme</label>
          <select id="themeSelect">
            <option value="terminal">Blacfox Terminal (default)</option>
            <option value="neon">Blacfox Neon</option>
            <option value="minimal">Blacfox Minimal</option>
          </select>

          <div class="sep"></div>
          <label for="sessionInput">Session code (all devices must match)</label>
          <div class="row">
            <input id="sessionInput" placeholder="e.g. fox123" />
            <button class="btn" id="saveSessionCode">Use code</button>
          </div>
          <p class="muted" style="margin-top:6px">QR updates automatically.</p>
        </div>

        <div class="panel" onmousemove="setGlow(event)">
          <h3>Attendance</h3>
          <div id="adminAttendance"></div>
          <div class="sep"></div>
          <div id="adminMsg" class="muted" style="margin-top:10px"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Identity Modal -->
<div class="modal" id="idModal" aria-hidden="true">
  <div class="modal-card">
    <h3 class="modal-title">Confirm your identity</h3>
    <label for="idSelect">I am</label>
    <select id="idSelect"></select>
    <div class="modal-actions">
      <button class="btn" id="idCancel">Not now</button>
      <button class="btn accent" id="idOk">Confirm</button>
    </div>
    <p class="muted" style="margin-top:8px">Selecting your name also marks you present. <br/>You can also choose <b>Observer</b> for the TV screen.</p>
  </div>
</div>

<!-- PIN Modal (voters must pass if enabled) -->
<div class="modal" id="pinModal" aria-hidden="true">
  <div class="modal-card">
    <h3 class="modal-title">Enter session PIN</h3>
    <div class="row">
      <input id="pinInput" inputmode="numeric" maxlength="6" placeholder="4–6 digits" />
    </div>
    <div class="modal-actions">
      <button class="btn" id="pinCancel">Cancel</button>
      <button class="btn accent" id="pinOk">Unlock voting</button>
    </div>
    <p class="muted" id="pinMsg" style="margin-top:8px"></p>
  </div>
</div>

<!-- QR library (with fallback) -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
/* =========================
   CONFIG: using your Firebase project
========================= */
window.BF_SYNC = {
  provider: 'firebase',
  // Default session (can be overridden by ?s= param or Admin panel)
  sessionId: 'demo',
  firebaseConfig: {
    apiKey: "AIzaSyCPowEBl-_CSqIObkgddFD2ZrvcXS4DsO4",
    authDomain: "bf-star-player.firebaseapp.com",
    databaseURL: "https://bf-star-player-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bf-star-player",
    storageBucket: "bf-star-player.firebasestorage.app",
    messagingSenderId: "225126593395",
    appId: "1:225126593395:web:e3e70364b8fef101f9cb06",
    measurementId: "G-RPHVLD60B1"
  }
};

/* =========================
   Storage keys & defaults
========================= */
const LS = { team:'bf_team', votes:'bf_votes', voted:'bf_voted_by', user:'bf_current_user', phase:'bf_phase', theme:'bf_theme', session:'bf_session', pinok:'bf_pinok_' };

const DEFAULT_MEMBERS = [
  {name:'Olwethu',     initials:'OB', status:'absent'},
  {name:'Christopher', initials:'CB', status:'absent'},
  {name:'Malaika',     initials:'MR', status:'absent'},
  {name:'Amilio',      initials:'AB', status:'absent'},
  {name:'Zubair',      initials:'ZS', status:'absent'},
  {name:'Amjad',       initials:'AZ', status:'absent'},
  {name:'Jerome',      initials:'JM', status:'absent'},
  {name:'Emilio',      initials:'ED', status:'absent'},
  {name:'Benita',      initials:'BJ', status:'absent'},
  {name:'Jaydon',      initials:'JV', status:'absent'},
  {name:'Stehpan',     initials:'SE', status:'absent'},
  {name:'Kerushan',    initials:'KG', status:'absent'},
  {name:'Payal',       initials:'PS', status:'absent'},
  {name:'Yudhveer',    initials:'YM', status:'absent'},
  {name:'Rinolan',     initials:'RR', status:'absent'},
  {name:'Fhad',        initials:'FW', status:'absent'},
  {name:'Brendon',     initials:'BS', status:'absent'},
];

/* =========================
   Local mirrors (fallback/offline)
========================= */
function loadTeamLocal(){ const raw = localStorage.getItem(LS.team); const t = raw?JSON.parse(raw):DEFAULT_MEMBERS.slice(); return t.map(m=>({name:''+m.name, initials:(''+m.initials).toUpperCase(), status:m.status==='present'?'present':'absent'})); }
function saveTeamLocal(t){ localStorage.setItem(LS.team, JSON.stringify(t)); }
function loadVotesLocal(){ return JSON.parse(localStorage.getItem(LS.votes)||'{}'); }
function saveVotesLocal(v){ localStorage.setItem(LS.votes, JSON.stringify(v)); }
function loadVotedLocal(){ return JSON.parse(localStorage.getItem(LS.voted)||'[]'); }
function saveVotedLocal(a){ localStorage.setItem(LS.voted, JSON.stringify(a)); }

function getUser(){ return sessionStorage.getItem(LS.user) || ''; }
function setUser(i){ if(i) sessionStorage.setItem(LS.user, i); else sessionStorage.removeItem(LS.user); updateNav(); }

function getPhaseLocal(){ return localStorage.getItem(LS.phase) || 'not_started'; }
function setPhaseLocal(p){ localStorage.setItem(LS.phase, p); renderPhase(); renderTeam(); renderMd(); renderVote(); }

/* =========================
   State (rendered)
========================= */
let teamMembers = loadTeamLocal();
let votes = loadVotesLocal();
let votedInitials = loadVotedLocal();
let pendingPick = '';
let sessionId = (new URLSearchParams(location.search).get('s')) || localStorage.getItem(LS.session) || (window.BF_SYNC && window.BF_SYNC.sessionId) || 'demo';
localStorage.setItem(LS.session, sessionId);

let sessionPin = '';        // from DB
let pinEnabled = false;     // from DB

/* =========================
   Firebase Sync layer
========================= */
const SYNC = (()=>{
  let enabled = false, app=null, db=null, rootRef=null;
  const listeners = [];

  function init(){
    const cfg = window.BF_SYNC || {};
    if(!cfg.firebaseConfig || !cfg.firebaseConfig.apiKey || !cfg.sessionId){ console.log('SYNC: No Firebase config; running local-only.'); return; }
    try{ app = firebase.apps.length ? firebase.app() : firebase.initializeApp(cfg.firebaseConfig); }
    catch(e){ console.warn('Firebase init:', e); }
    db = firebase.database();
    setSession(cfg.sessionId || 'demo');
  }

  function setSession(id){
    detach();
    sessionId = id || 'demo';
    localStorage.setItem(LS.session, sessionId);
    rootRef = db.ref('sessions/'+sessionId);
    enabled = true;

    // Attach listeners
    attach(rootRef.child('phase'), s=> { if(s.exists()) setPhaseLocal(s.val()); });
    attach(rootRef.child('team'),  s=> { teamMembers = s.val() || DEFAULT_MEMBERS.slice(); saveTeamLocal(teamMembers); renderTeam(); renderVote(); renderMd(); ensureQr(); });
    attach(rootRef.child('votes'), s=> { votes = s.val() || {}; saveVotesLocal(votes); renderTeam(); renderMd(); });
    attach(rootRef.child('votedBy'), s=> { votedInitials = Object.keys(s.val()||{}); saveVotedLocal(votedInitials); renderTeam(); renderMd(); renderVote(); });
    attach(rootRef.child('pin'), s=> { sessionPin = (s.val() || '').toString(); updatePinUi(); });
    attach(rootRef.child('pinEnabled'), s=> { pinEnabled = !!s.val(); updatePinUi(); renderVote(); });

    // Ensure default tree exists (once)
    rootRef.once('value').then(s=>{
      if(!s.child('team').exists()) rootRef.child('team').set(teamMembers);
      if(!s.child('votes').exists()) rootRef.child('votes').set(votes);
      if(!s.child('votedBy').exists()) rootRef.child('votedBy').set({});
      if(!s.child('phase').exists()) rootRef.child('phase').set(getPhaseLocal());
      if(!s.child('pinEnabled').exists()) rootRef.child('pinEnabled').set(false);
    }).catch(console.warn);
  }

  function attach(ref, fn){ ref.on('value', fn); listeners.push({ref, fn}); }
  function detach(){ listeners.forEach(({ref, fn})=> ref.off('value', fn)); listeners.length=0; }

  // Public ops
  function setPhase(p){ if(!enabled) return setPhaseLocal(p); return rootRef.child('phase').set(p); }
  function saveTeam(t){ if(!enabled){ saveTeamLocal(t); setTimeout(()=>{ renderTeam(); renderVote(); renderMd(); },0); return; } return rootRef.child('team').set(t); }
  function markPresent(initials, present){
    const idx = teamMembers.findIndex(m=>m.initials===initials);
    if(idx>-1){ teamMembers[idx].status = present?'present':'absent'; }
    return saveTeam(teamMembers);
  }
  function resetSession(keepAttendance){
    if(!enabled){
      votes={}; votedInitials=[]; saveVotesLocal(votes); saveVotedLocal(votedInitials); setPhaseLocal('not_started'); return;
    }
    const updates = {};
    updates['votes'] = {};
    updates['votedBy'] = {};
    updates['phase'] = 'not_started';
    return rootRef.update(updates);
  }
  function generatePin(){
    const pin = (''+Math.floor(1000 + Math.random()*9000)); // 4 digits
    return rootRef.child('pin').set(pin);
  }
  function setPinEnabled(on){ return rootRef.child('pinEnabled').set(!!on); }
  async function voteTransaction(voterInitials, pickInitials){
    if(!enabled){
      // local-only fallback
      if(votedInitials.includes(voterInitials)) throw new Error('already_voted');
      votes[pickInitials] = (votes[pickInitials]||0) + 1; votedInitials.push(voterInitials);
      saveVotesLocal(votes); saveVotedLocal(votedInitials); renderTeam(); renderMd(); return;
    }
    // 1) Claim the voter's slot atomically
    const claimRef = rootRef.child('votedBy/'+voterInitials);
    const res = await claimRef.transaction(curr => curr ? curr : true);
    if(!res.committed){ throw new Error('already_voted'); }
    // 2) Increment the pick's total atomically
    await rootRef.child('votes/'+pickInitials).transaction(curr => (curr||0)+1);
  }

  return { init, setSession, setPhase, saveTeam, markPresent, resetSession, generatePin, setPinEnabled, voteTransaction, get enabled(){ return enabled; } };
})();

/* =========================
   Helpers & UI
========================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function showView(id){
  $$('main > section').forEach(s=>s.classList.add('hide'));
  $('#view-'+id).classList.remove('hide');
  if(id==='team'){ renderTeam(); renderMd(); renderPhase(); ensureQr(); }
  if(id==='vote'){ renderVote(); }
  if(id==='admin'){ renderAdmin(); }
}

function resultsData(){ return teamMembers.map(m=>({ name:m.name, initials:m.initials, votes:Number(votes[m.initials]||0) })).sort((a,b)=>b.votes-a.votes||a.name.localeCompare(b.name)); }
function tallies(){
  const present = teamMembers.filter(m=>m.status==='present').length;
  const eligible = teamMembers.filter(m=>m.status==='present' && m.initials!=='KG').length;
  return { total:teamMembers.length, present, eligible, absent:teamMembers.length-present, voted:new Set(votedInitials).size };
}

function updateNav(){
  const u = getUser();
  $('#whoAmIText').innerHTML = !u ? `<a id="changeId">Set identity</a>` : (u==='OBSERVER' ? `You are: Observer <span class="muted">(<a id="changeId">change</a>)</span>` : `You are: ${u} <span class="muted">(<a id="changeId">change</a>)</span>`);
  $('#adminNav').classList.toggle('hide', getUser()!=='ZS');
  const link = $('#changeId'); if(link) link.addEventListener('click', e=>{ e.preventDefault(); openIdentityModal(); });
}

function setGlow(e){
  const r = e.currentTarget.getBoundingClientRect();
  e.currentTarget.style.setProperty('--gx', ((e.clientX - r.left)/r.width*100)+'%');
  e.currentTarget.style.setProperty('--gy', ((e.clientY - r.top)/r.height*100)+'%');
}

/* Header autohide for TV */
let hideTimer=null;
function pingActivity(){
  clearTimeout(hideTimer);
  $('#appHeader').classList.remove('autohide');
  $('#qrBox')?.classList.remove('fade');
  hideTimer = setTimeout(()=>{ $('#appHeader').classList.add('autohide'); $('#qrBox')?.classList.add('fade'); }, 10000);
}
['mousemove','keydown','click','touchstart'].forEach(ev=> document.addEventListener(ev, pingActivity));

/* THEME */
function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem(LS.theme, t); }

/* TEAM VIEW */
function renderPhase(){
  const p = getPhaseLocal();
  const pill = $('#phasePill'), text = $('#phaseText');
  text.classList.remove('typing');
  if(p==='not_started'){ pill.className='pill idle'; pill.textContent='Waiting'; text.textContent='Waiting to begin…'; }
  else if(p==='open'){ pill.className='pill open'; pill.textContent='Voting'; text.textContent='Voting still in progress'; text.classList.add('typing'); }
  else { pill.className='pill closed'; pill.textContent='Closed'; text.textContent='Winner revealed'; }
  const revealed = p==='revealed';
  $('#resultsHint').classList.toggle('hide', revealed);
  $('#teamBars').classList.toggle('hide', !revealed);
  $('#resultsTitle').textContent = revealed ? 'Results' : 'Results (hidden)';
}
function renderTeam(){
  const {total, present, absent, voted} = (function(){ const t=tallies(); return {total:t.total, present:t.present, absent:t.absent, voted:t.voted}; })();
  $('#t-total').textContent = total; $('#t-present').textContent = present; $('#t-absent').textContent = absent; $('#t-voted').textContent = voted;

  const tb = $('#teamTable tbody');
  tb.innerHTML = teamMembers.map(m=>`<tr><td>${m.name}</td><td><strong>${m.initials}</strong></td><td>${m.status==='present'?'<span class="chip ok">Present</span>':'<span class="chip abs">Absent</span>'}</td></tr>`).join('');

  const bars = $('#teamBars'), data = resultsData(), max = Math.max(1, ...data.map(d=>d.votes));
  bars.innerHTML = data.map(d=>`<div style="margin:10px 0">
    <div class="row" style="align-items:center">
      <div style="font-weight:800;">${d.name} <span class="muted">(${d.initials})</span></div>
      <div style="margin-left:auto" class="chip">${d.votes} vote${d.votes===1?'':'s'}</div>
    </div>
    <div class="bar"><span style="width:${Math.round((d.votes/max)*100)}%"></span></div>
  </div>`).join('');
}
function updatePinUi(){
  const show = getUser()==='KG';
  $('#pinPanel').classList.toggle('hide', !show);
  if(!show) return;
  $('#pinEnable').checked = !!pinEnabled;
  $('#pinValue').textContent = pinEnabled ? `PIN: ${sessionPin||'—'}` : 'PIN disabled';
}
function renderMd(){
  const isKG = getUser()==='KG';
  $('#mdPanel').classList.toggle('hide', !isKG);
  if(!isKG) return;
  const {present, eligible, voted} = tallies();
  $('#mdPresent').textContent = present; $('#mdVotes').textContent = voted;
  const ph = getPhaseLocal();
  $('#btnStart').classList.toggle('hide', ph!=='not_started');
  $('#btnReveal').classList.toggle('hide', ph!=='open');
  const shouldSuggest = ph==='open' && voted >= Math.max(0, eligible - 1);
  $('#btnCloseReveal').classList.toggle('hide', !shouldSuggest);
  updatePinUi();
}
function mdStartVoting(){ SYNC.setPhase('open'); }
function mdReveal(){ SYNC.setPhase('revealed'); $('#qrBox')?.classList.add('fade'); revealOverlay(); }
function mdCloseRevealNow(){ mdReveal(); }

/* QR (includes session code) */
function ensureQr(){
  const holder = $('#qr'); if(!holder) return;
  holder.innerHTML = '';
  const base = location.href.split('#')[0].split('?')[0];
  const url = `${base}?s=${encodeURIComponent(sessionId)}#view-vote`;
  try{ if(window.QRCode){ new QRCode(holder, {text:url, width:128, height:128, correctLevel: QRCode.CorrectLevel.M}); } else { holder.innerHTML = `<a href="${url}" class="muted" style="font-size:12px">Open Vote</a>`; } }
  catch{ holder.innerHTML = `<a href="${url}" class="muted" style="font-size:12px">Open Vote</a>`; }
}

/* CONFETTI (adaptive) */
function confettiMultiplier(){
  if(window.matchMedia && matchMedia('(prefers-reduced-motion: reduce)').matches) return 0;
  const cores = navigator.hardwareConcurrency || 4;
  return cores <= 4 ? 0.6 : 1;
}
function revealOverlay(){
  const data = resultsData();
  const top = Math.max(0, ...data.map(d=>d.votes));
  if(top===0){
    const o = document.createElement('div'); o.className='drumroll';
    o.innerHTML = `<div class="winner-reveal"><div class="winner-title">No votes cast</div></div>`;
    document.body.appendChild(o); setTimeout(()=>o.remove(), 2000); return;
  }
  const winners = data.filter(d=>d.votes===top);
  const o = document.createElement('div'); o.className='drumroll';
  o.innerHTML = `<div class="drumroll-text">Drum roll…</div><div class="countdown" id="dr-count">10</div><div class="drumroll-bar"><div class="bar-fill" id="dr-fill"></div></div>`;
  document.body.appendChild(o);

  let remain = 10; const num = o.querySelector('#dr-count'); const fill = o.querySelector('#dr-fill'); fill.style.width='0%';
  const tick = setInterval(()=>{
    remain -= 1; num.textContent = remain; fill.style.width = `${(10-remain)*10}%`;
    o.style.transform = remain%2===0 ? 'translateY(-2px)' : 'translateY(0)';
    if(remain<=0){
      clearInterval(tick);
      const co = winners.length>1;
      const title = co ? '<div class="winner-title co">Co-Winners</div>' : '<div class="winner-title">Star Player</div>';
      o.innerHTML = `<div class="winner-reveal">${title}<div class="winner-name">${winners.map(w=>w.name).join(co?' • ':' & ')}</div></div>`;
      const mult = confettiMultiplier();
      const count = Math.round((co?120:150) * mult);
      if(mult>0){ for(let i=0;i<count;i++) spawnConfetti(co?{half:i%2===0?'left':'right'}:{}); }
      setTimeout(()=>o.remove(), 6000);
    }
  },1000);
}
function spawnConfetti(opts={}){
  const el = document.createElement('div'); el.className='confetti';
  const colors = ['#ffffff','#ffe8cc','#ffb26a','#ff7a00','#ffd166'];
  const half = opts.half || 'full'; let left;
  if(half==='left') left=Math.random()*45; else if(half==='right') left=55+Math.random()*45; else left=Math.random()*100;
  const size = 6 + Math.random()*8, rot = Math.random()*360, dur = 3 + Math.random()*2;
  el.style.cssText = `left:${left}vw;top:-20px;width:${size}px;height:${(size*1.4)}px;background:${colors[Math.floor(Math.random()*colors.length)]};transform:rotate(${rot}deg);opacity:.95;transition:transform ${dur}s cubic-bezier(.2,.9,.2,1.05), top ${dur}s cubic-bezier(.2,.9,.2,1.05), opacity ${dur}s linear`;
  document.body.appendChild(el);
  requestAnimationFrame(()=>{
    el.style.top='110vh';
    const dir = half==='left' ? (20+Math.random()*60) : half==='right' ? -(20+Math.random()*60) : ((Math.random()*2-1)*120);
    el.style.transform = `translateX(${dir}px) rotate(${rot+600}deg)`; el.style.opacity = .1;
  });
  setTimeout(()=> el.remove(), dur*1000+500);
}

/* Vote UI with explicit blockers + PIN gate */
function renderVote(){
  const u = getUser();
  $('#idStatus').textContent = u ? (u==='OBSERVER' ? 'Confirmed as Observer' : `Confirmed as ${u}`) : 'Not set';

  const guard = $('#voteGuard');
  const form  = $('#voteForm');
  const msg   = $('#voteMsg');

  const showBlock = (text) => { guard.textContent = text; guard.classList.remove('hide'); form.classList.add('hide'); msg.textContent = ''; };
  const showForm  = () => { guard.classList.add('hide'); form.classList.remove('hide'); };

  if(!u){ showBlock('Confirm your identity to proceed.'); return; }
  if(u==='OBSERVER'){ showBlock('Observer mode: voting unavailable.'); return; }
  if(u==='KG'){ showBlock('Hi KG. Use Team View to start voting and reveal the winner.'); return; }

  const ph = getPhaseLocal();
  if(ph==='not_started'){ showBlock('Voting has not started yet. Ask KG to press “Start Voting” on Team View.'); return; }
  if(ph==='revealed'){ showBlock('Voting is closed.'); return; }
  if(votedInitials.includes(u)){ showBlock('You have already voted this session.'); return; }

  // PIN gate (once per device per session)
  const pinOk = localStorage.getItem(LS.pinok + sessionId) === '1';
  if(SYNC.enabled && pinEnabled && !pinOk){
    openPinModal(); showBlock('Enter the session PIN to unlock voting.');
    return;
  }

  const presentCount = teamMembers.filter(m=>m.status==='present').length;
  const eligible = teamMembers.filter(m=>m.status==='present' && m.initials!==u);
  if(presentCount <= 1){ showBlock('No eligible teammates are present. At least two people must be marked Present.'); return; }
  if(eligible.length === 0){ showBlock('No eligible teammates are available to vote for. Ask ZS to mark teammates Present in Admin.'); return; }

  $('#voteFor').innerHTML = '<option value="">Select a teammate…</option>' + eligible.map(m=>`<option value="${m.initials}">${m.name} — ${m.initials}</option>`).join('');
  msg.textContent = 'Pick a teammate (not yourself), then Confirm → Submit.';
  $('#confirmVote').disabled = false; $('#submitVote').disabled = true; pendingPick = '';
  showForm();
}

function voteConfirmStep(){
  const u = getUser();
  const sel = $('#voteFor').value.trim().toUpperCase();
  const msg = $('#voteMsg');
  if(!u){ msg.textContent='Confirm identity first.'; return; }
  if(getPhaseLocal()!=='open'){ msg.textContent='Voting is not open.'; return; }
  if(!sel){ msg.textContent='Select your pick from the dropdown.'; return; }
  if(sel===u){ msg.textContent='Self-votes are not allowed. Please choose another teammate.'; return; }
  const pickRec = teamMembers.find(t=>t.initials===sel && t.status==='present'); if(!pickRec){ msg.textContent='Selected teammate is not currently marked Present.'; return; }
  pendingPick = sel; $('#submitVote').disabled = false; msg.textContent = `Confirming: your vote for ${pickRec.name} (${pickRec.initials}). Click “Submit vote” to finalize.`;
}

async function voteSubmit(){
  const u = getUser();
  const msg = $('#voteMsg');
  if(!u){ msg.textContent='Confirm identity first.'; return; }
  if(getPhaseLocal()!=='open'){ msg.textContent='Voting is not open.'; return; }
  if(votedInitials.includes(u)){ msg.textContent='You have already voted.'; return; }
  if(!pendingPick){ msg.textContent='Please confirm your selection first.'; return; }
  try{
    await SYNC.voteTransaction(u, pendingPick);
    msg.textContent = 'Vote recorded. Thank you!';
    $('#submitVote').disabled = true;
    for(let i=0;i<Math.round(25*confettiMultiplier());i++) spawnConfetti();
  }catch(e){
    msg.textContent = e && e.message==='already_voted' ? 'You have already voted.' : 'Could not submit vote. Please try again.';
  }
}

function clearPick(){ pendingPick=''; $('#voteFor').value=''; $('#voteMsg').textContent=''; $('#submitVote').disabled=true; }

/* Identity modal */
function openIdentityModal(){
  const idSel = $('#idSelect');
  const u = getUser();
  idSel.innerHTML = [
    `<option value="">Select your name…</option>`,
    `<option value="OBSERVER"${u==='OBSERVER'?' selected':''}>Observer — TV</option>`,
    ...teamMembers.map(m=>`<option value="${m.initials}" ${u===m.initials?'selected':''}>${m.name} — ${m.initials}</option>`)
  ].join('');
  $('#idModal').classList.add('active');
}
function closeIdentityModal(){ $('#idModal').classList.remove('active'); }
function confirmIdentity(){
  const val = $('#idSelect').value.trim().toUpperCase();
  if(!val) return;
  if(val==='OBSERVER'){ setUser('OBSERVER'); }
  else{
    const rec = teamMembers.find(t=>t.initials===val); if(!rec) return;
    rec.status='present'; SYNC.saveTeam(teamMembers); setUser(val);
  }
  updateNav(); renderTeam(); renderMd(); renderVote(); ensureQr(); closeIdentityModal();
}

/* PIN modal (voters) */
function openPinModal(){ $('#pinModal').classList.add('active'); $('#pinMsg').textContent=''; $('#pinInput').value=''; }
function closePinModal(){ $('#pinModal').classList.remove('active'); }
function checkPin(){
  const entered = ($('#pinInput').value||'').trim();
  if(!entered){ $('#pinMsg').textContent='Enter the PIN shown on the Team View.'; return; }
  if(entered === (sessionPin||'')){
    localStorage.setItem(LS.pinok + sessionId, '1'); $('#pinMsg').textContent='Unlocked!'; closePinModal(); renderVote();
  }else{
    $('#pinMsg').textContent='Incorrect PIN. Try again.';
  }
}

/* Admin (ZS only) */
function renderAdmin(){
  if(getUser()!=='ZS'){
    $('#view-admin').innerHTML = `<div class="panel"><h2>Admin</h2><p class="muted">Access denied. This section is visible only when the confirmed user is ZS.</p></div>`;
    return;
  }
  // Rebuild layout
  $('#view-admin').innerHTML = `
    <h2>Admin <span class="caret">_</span></h2>
    <div class="sub">Visible only when you’re <strong>ZS</strong>.</div>
    <div class="grid cols-2">
      <div class="panel" onmousemove="setGlow(event)">
        <h3>Team Members</h3>
        <label for="teamArea">Format: <code>Full Name - XX</code> per line</label>
        <textarea id="teamArea" spellcheck="false"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn accent" id="saveTeam">Save Team</button>
          <button class="btn" id="resetSession">New Day</button>
        </div>
        <p class="muted" style="margin-top:8px">Saves to the session (realtime sync) and locally for offline.</p>
        <div class="sep"></div>
        <label for="themeSelect">Theme</label>
        <select id="themeSelect">
          <option value="terminal">Blacfox Terminal (default)</option>
          <option value="neon">Blacfox Neon</option>
          <option value="minimal">Blacfox Minimal</option>
        </select>
        <div class="sep"></div>
        <label for="sessionInput">Session code (all devices must match)</label>
        <div class="row">
          <input id="sessionInput" placeholder="e.g. fox123" />
          <button class="btn" id="saveSessionCode">Use code</button>
        </div>
        <p class="muted" style="margin-top:6px">QR updates automatically.</p>
      </div>
      <div class="panel" onmousemove="setGlow(event)">
        <h3>Attendance</h3>
        <div id="adminAttendance"></div>
        <div class="sep"></div>
        <div id="adminMsg" class="muted" style="margin-top:10px"></div>
      </div>
    </div>`;

  $('#teamArea').value = teamMembers.map(m=>`${m.name} - ${m.initials}`).join('\n');

  const tgt = $('#adminAttendance');
  tgt.innerHTML = teamMembers.map((m,i)=>`<label style="display:flex;align-items:center;gap:10px;margin:6px 0">
    <input type="checkbox" data-i="${i}" ${m.status==='present'?'checked':''}/> ${m.name} <span class="muted">(${m.initials})</span>
  </label>`).join('');
  tgt.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const i=+e.target.getAttribute('data-i'); teamMembers[i].status = e.target.checked?'present':'absent';
      SYNC.saveTeam(teamMembers); $('#adminMsg').textContent='Attendance updated.'; renderTeam(); renderVote(); renderMd();
    });
  });

  $('#themeSelect').value = localStorage.getItem(LS.theme) || 'terminal';
  $('#themeSelect').addEventListener('change', e=> applyTheme(e.target.value));
  $('#saveTeam').addEventListener('click', saveTeamFromArea);
  $('#resetSession').addEventListener('click', newSession);

  // session code controls
  $('#sessionInput').value = sessionId || '';
  $('#saveSessionCode').addEventListener('click', ()=>{
    const val = ($('#sessionInput').value||'').trim();
    if(!val){ alert('Enter a session code'); return; }
    SYNC.setSession(val);
    ensureQr();
    renderVote();
    $('#adminMsg').textContent = 'Session code set. Share the new QR.';
  });
}

function saveTeamFromArea(){
  const arr=[]; for(const line of $('#teamArea').value.split('\n').map(x=>x.trim()).filter(Boolean)){ const m=line.match(/^(.+?)\s*-\s*([A-Za-z]{1,4})$/); if(m) arr.push({name:m[1].trim(), initials:m[2].toUpperCase(), status:'absent'}); }
  if(!arr.length){ alert('No valid lines. Use "Full Name - XX"'); return; }
  teamMembers=arr; SYNC.saveTeam(teamMembers);
  votes={}; votedInitials=[]; saveVotesLocal(votes); saveVotedLocal(votedInitials);
  $('#adminMsg').textContent='Team saved. Session reset.'; SYNC.resetSession(true); renderTeam(); renderVote(); renderMd(); renderPhase(); ensureQr();
}

/* "New Day" — clears votes & phase; keeps team & attendance */
function newSession(){
  if(!confirm('Start a new day? This clears votes & who voted, keeps team & attendance.')) return;
  votes={}; votedInitials=[]; saveVotesLocal(votes); saveVotedLocal(votedInitials);
  SYNC.resetSession(true);
  $('#adminMsg').textContent='New day started.'; renderTeam(); renderVote(); renderMd(); renderPhase(); ensureQr();
}

/* Fullscreen */
function toggleFullscreen(){ const doc=document; const el=document.documentElement; if(!doc.fullscreenElement){ el.requestFullscreen?.(); } else { doc.exitFullscreen?.(); } }
$('#fsToggle').addEventListener('click', toggleFullscreen);

/* Particles */
function initParticles(){
  const p=$('#particles'); if(!p) return;
  const base = 28 * (window.matchMedia && matchMedia('(prefers-reduced-motion: reduce)').matches ? 0.4 : 1);
  for(let i=0;i<base;i++){
    const s=document.createElement('span'); s.className='particle'+(Math.random()<.45?' o':'');
    s.style.setProperty('--x', Math.floor(Math.random()*100)+'vw');
    s.style.setProperty('--dx', (Math.random()*40-20)+'px');
    s.style.setProperty('--s', (0.6+Math.random()*0.9).toFixed(2));
    s.style.animationDuration = (8+Math.random()*8).toFixed(2)+'s';
    s.style.animationDelay = (-Math.random()*8).toFixed(2)+'s';
    p.appendChild(s);
  }
}

/* Boot screen */
function killBoot(){ const b=$('#boot'); if(b){ b.classList.add('hide'); setTimeout(()=>b.remove(), 400); } }

/* Hash deep link */
window.addEventListener('hashchange', ()=>{
  if(location.hash==='#view-vote') showView('vote');
  else if(location.hash==='#view-admin') showView('admin');
  else showView('team');
});

/* Events */
$$('nav .btn[data-view]').forEach(b=> b.addEventListener('click', e=> showView(e.target.getAttribute('data-view'))));
$('#btnStart').addEventListener('click', mdStartVoting);
$('#btnReveal').addEventListener('click', mdReveal);
$('#btnCloseReveal').addEventListener('click', mdCloseRevealNow);
$('#openIdentity').addEventListener('click', openIdentityModal);
$('#clearIdentity').addEventListener('click', ()=>{ setUser(''); renderVote(); renderMd(); updateNav(); ensureQr(); });
$('#confirmVote').addEventListener('click', voteConfirmStep);
$('#submitVote').addEventListener('click', voteSubmit);
$('#idCancel').addEventListener('click', closeIdentityModal);
$('#idOk').addEventListener('click', confirmIdentity);
$('#pinOk').addEventListener('click', checkPin);
$('#pinCancel').addEventListener('click', closePinModal);

/* KG-only PIN controls */
$('#pinGenerate').addEventListener('click', ()=> SYNC.generatePin());
$('#pinEnable').addEventListener('change', (e)=> SYNC.setPinEnabled(e.target.checked));

/* Init */
(function init(){
  // theme
  applyTheme(localStorage.getItem(LS.theme) || 'terminal');

  // local mirrors persisted
  saveTeamLocal(teamMembers); saveVotesLocal(votes); saveVotedLocal(votedInitials);

  // Firebase sync boot
  const qs = new URLSearchParams(location.search);
  if(qs.get('s')){ sessionId = qs.get('s'); localStorage.setItem(LS.session, sessionId); }
  // inject chosen sessionId to config for first init
  if(window.BF_SYNC) window.BF_SYNC.sessionId = sessionId;
  SYNC.init();

  updateNav(); renderPhase(); renderTeam(); renderMd(); renderVote();
  if(location.hash==='#view-vote') showView('vote'); else if(location.hash==='#view-admin') showView('admin'); else showView('team');

  initParticles(); ensureQr();
  if(!getUser()) openIdentityModal();

  // 5s boot screen
  setTimeout(killBoot, 5000);

  // Register PWA SW (optional)
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }

  pingActivity(); // start autohide loop
})();
</script>
</body>
</html>
