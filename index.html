<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blacfox ‚Ä¢ Star Player</title>
<meta name="color-scheme" content="dark" />
<meta name="theme-color" content="#ff7a00">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="logo.png" />

<!-- Social share -->
<meta property="og:title" content="Blacfox ‚Ä¢ Star Player" />
<meta property="og:description" content="Vote, reveal, celebrate: the Blacfox Star Player mini-app." />
<meta property="og:type" content="website" />
<meta property="og:image" content="logo.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Blacfox ‚Ä¢ Star Player" />
<meta name="twitter:description" content="Vote, reveal, celebrate: the Blacfox Star Player mini-app." />
<meta name="twitter:image" content="logo.png" />

<!-- Fonts: sleek headings, retro UI chrome -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="pico.min.css">

<!-- Firebase (compat builds) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#050506;
    --bg-gradient:radial-gradient(circle at 20% -10%, rgba(255,122,0,.22), rgba(255,122,0,0) 60%), radial-gradient(circle at 110% 0%, rgba(102,0,20,.35), rgba(0,0,0,0) 70%), #050506;
    --panel:#121218;
    --panel2:#0d0e13;
    --panel-glass:rgba(16,16,24,.6);
    --ink:#f5f5f8;
    --muted:rgba(235,236,240,.62);
    --accent:#ff7a00;
    --accent-rgb:255,122,0;
    --accent-soft:rgba(255,122,0,.16);
    --ring:#f7b98a;
    --ease:cubic-bezier(.22,.9,.25,1.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg-gradient);
    color:var(--ink);
    font:15px/1.6 "Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
    letter-spacing:.2px;
    position:relative;
    overflow-x:hidden;
    --tilt-x:0deg;
    --tilt-y:0deg;
    --glow-x:50;
    --glow-y:50;
    --scroll-depth:0;
    --scroll-ambient:0;
  }
  h1,h2{font-family:'Orbitron', 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; letter-spacing:.4px}
  h3{font-family:'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; letter-spacing:.2px}
  h1{font-weight:700} h2{font-weight:700} h3{font-weight:700}

  .bg-layers{
    position:fixed;
    inset:0;
    overflow:hidden;
    z-index:0;
    pointer-events:none;
    --parallax-x:50;
    --parallax-y:50;
  }
  .bg-stars,
  .bg-halo{
    position:absolute;
    inset:-40%;
  }
  .bg-stars{
    background:
      radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.6), transparent),
      radial-gradient(1px 1px at 20% 80%, rgba(255,122,0,.4), transparent),
      radial-gradient(1px 1px at 70% 30%, rgba(255,255,255,.5), transparent),
      radial-gradient(1px 1px at 80% 60%, rgba(255,122,0,.3), transparent),
      radial-gradient(2px 2px at 35% 45%, rgba(255,255,255,.7), transparent),
      radial-gradient(1px 1px at 55% 15%, rgba(255,122,0,.5), transparent);
    background-size:45% 45%, 55% 55%, 65% 65%, 70% 70%, 80% 80%, 90% 90%;
    animation:starDrift 60s linear infinite;
    opacity:.35;
    transition:transform .8s var(--ease);
    transform:translate3d(calc((var(--parallax-x) - 50)*-0.6px), calc((var(--parallax-y) - 50)*-0.4px - var(--scroll-depth)*0.3px), 0);
  }
  .bg-halo{
    background:
      radial-gradient(circle at 20% 40%, rgba(255,122,0,.22), transparent 45%),
      radial-gradient(circle at 80% 60%, rgba(102,0,20,.32), transparent 60%);
    filter:blur(60px);
    animation:haloPulse 18s ease-in-out infinite;
    opacity:.55;
    transition:transform 1s var(--ease);
    transform:translate3d(calc((var(--parallax-x) - 50)*0.3px), calc((var(--parallax-y) - 50)*0.6px + var(--scroll-depth)*0.25px),0);
  }
  @keyframes starDrift{
    0%{transform:translate3d(-2%,0,0) scale(1);}
    50%{transform:translate3d(1%,2%,0) scale(1.05);}
    100%{transform:translate3d(-2%,0,0) scale(1);}
  }
  @keyframes haloPulse{
    0%,100%{transform:translate3d(-2%,2%,0) scale(1);}
    40%{transform:translate3d(1%,-1%,0) scale(1.08);}
    70%{transform:translate3d(-1%,1%,0) scale(.97);}
  }
  @keyframes viewFade{
    0%{ opacity:0; transform:translateY(24px) scale(.98); }
    100%{ opacity:1; transform:translateY(0) scale(1); }
  }
  .texture-noise,
  .frame-vignette{
    position:fixed;
    inset:0;
    pointer-events:none;
    z-index:0;
  }
  .texture-noise{
    background:
      radial-gradient(1px 1px at 12% 22%, rgba(255,255,255,.08), transparent),
      radial-gradient(1px 1px at 32% 68%, rgba(255,255,255,.05), transparent),
      radial-gradient(1px 1px at 78% 34%, rgba(255,122,0,.06), transparent),
      radial-gradient(1px 1px at 56% 82%, rgba(255,255,255,.05), transparent);
    background-size:140px 140px, 180px 180px, 210px 210px, 260px 260px;
    mix-blend-mode:soft-light;
    opacity:.14;
    animation:noiseShift .8s steps(2) infinite;
  }
  .frame-vignette{
    background:radial-gradient(circle at center, transparent 45%, rgba(0,0,0,.55) 100%);
    opacity:.35;
    transition:opacity .8s var(--ease);
  }
  @keyframes noiseShift{
    0%{transform:translate3d(0,0,0);}
    50%{transform:translate3d(-2%,1%,0);}
    100%{transform:translate3d(0,0,0);}
  }

  /* Cinematic loading crawl */
  .boot{
    position:fixed; inset:0; z-index:10000;
    display:flex; align-items:center; justify-content:center;
    background:#000;
    color:#ffe0c3;
    overflow:hidden;
    perspective:900px;
    font-family:'Orbitron', 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
  }
  .boot-stars,
  .boot-vignette{
    position:absolute;
    inset:-25%;
    pointer-events:none;
  }
  .boot-stars{
    background:
      radial-gradient(1px 1px at 12% 22%, rgba(255,255,255,.9), transparent),
      radial-gradient(1px 1px at 78% 44%, rgba(255,208,150,.7), transparent),
      radial-gradient(1px 1px at 44% 66%, rgba(255,255,255,.8), transparent),
      radial-gradient(1px 1px at 32% 82%, rgba(255,122,0,.55), transparent),
      radial-gradient(1px 1px at 65% 28%, rgba(255,255,255,.85), transparent);
    background-size:120px 120px, 180px 180px, 220px 220px, 260px 260px, 300px 300px;
    animation:bootStars 18s linear infinite;
    opacity:.58;
  }
  .boot-vignette{
    background:radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,.8) 68%, rgba(0,0,0,.95) 100%);
    mix-blend-mode:multiply;
  }
  .boot-frame{
    position:relative;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:24px;
    text-align:center;
    transform-style:preserve-3d;
  }
  .boot-intro{
    max-width:520px;
    font:500 17px/1.7 "Inter", ui-sans-serif;
    letter-spacing:2px;
    text-transform:uppercase;
    color:#ffe7d1;
    opacity:0;
    animation:bootIntro 7.8s ease forwards;
  }
  .boot-intro p{
    margin:0;
    text-shadow:0 0 18px rgba(255,122,0,.2);
  }
  .boot-sigil{
    width:120px;
    height:120px;
    border-radius:50%;
    background:radial-gradient(circle at center, rgba(255,122,0,.35), rgba(0,0,0,.65));
    display:grid;
    place-items:center;
    box-shadow:0 0 28px rgba(255,122,0,.35);
    opacity:0;
    transform:scale(.85);
    animation:bootSigil 7.4s 1.8s ease forwards;
  }
  .boot-sigil img{
    width:72px;
    height:auto;
    filter:drop-shadow(0 0 12px rgba(255,122,0,.55));
  }
  .boot-logo{
    font:700 26px/1 'Orbitron', ui-sans-serif;
    letter-spacing:10px;
    text-transform:uppercase;
    color:var(--accent);
    text-shadow:0 0 26px rgba(255,122,0,.7);
    opacity:0;
    animation:bootLogo 7.8s 3s cubic-bezier(.42,0,.2,1) forwards;
  }
  .boot-logo span{color:#fff;}
  .boot-crawl{
    position:relative;
    width:min(420px, 80vw);
    height:220px;
    overflow:hidden;
    transform:rotateX(18deg);
    opacity:0;
    animation:bootCrawlWrap 12.7s 3.8s ease forwards;
  }
  .boot-crawl .crawl{
    position:absolute;
    bottom:-160%;
    width:100%;
    display:flex;
    flex-direction:column;
    gap:8px;
    font:600 16px/1.85 "Inter", ui-sans-serif;
    letter-spacing:4px;
    text-transform:uppercase;
    color:#ffe0c3;
    text-shadow:0 0 12px rgba(255,122,0,.4);
    animation:bootCrawl 12s 3.8s linear forwards;
  }
  .boot-crawl .crawl span{display:block;}
  .boot.hide{animation:fadeOut .5s ease forwards}
  @keyframes fadeOut{to{opacity:0; visibility:hidden;}}
  @keyframes bootStars{
    0%{transform:translate3d(0,0,0) scale(1);}
    50%{transform:translate3d(-2%,1%,0) scale(1.05);}
    100%{transform:translate3d(0,0,0) scale(1);}
  }
  @keyframes bootIntro{
    0%{opacity:0; transform:translateY(28px);}
    18%{opacity:1; transform:translateY(0);}
    78%{opacity:1; transform:translateY(0);}
    100%{opacity:0; transform:translateY(-36px);}
  }
  @keyframes bootSigil{
    0%{opacity:0; transform:scale(.82) rotate(-8deg);}
    28%{opacity:1; transform:scale(1) rotate(0deg);}
    65%{opacity:1; transform:scale(1.04) rotate(2deg);}
    100%{opacity:.95; transform:scale(1) rotate(0deg);}
  }
  @keyframes bootLogo{
    0%{opacity:0; transform:translateZ(-140px) scale(.82);}
    42%{opacity:1; transform:translateZ(0) scale(1);}
    82%{opacity:1; transform:translateZ(24px) scale(1.05);}
    100%{opacity:.9; transform:translateZ(0) scale(1);}
  }
  @keyframes bootCrawlWrap{
    0%{opacity:0;}
    40%{opacity:1;}
    100%{opacity:1;}
  }
  @keyframes bootCrawl{
    0%{transform:translate3d(0,0,0);}
    100%{transform:translate3d(0,-150%,0);}
  }

  /* Watermark */
  .wm{
    position:fixed; inset:0; pointer-events:none; z-index:0;
    background:url("blacfox-watermark.png") no-repeat center;
    background-size:clamp(340px, 42vw, 720px);
    mix-blend-mode:soft-light;
    filter:drop-shadow(0 0 18px rgba(15,18,24,.18));
    opacity:.22;
    animation:watermarkDrift 22s ease-in-out infinite;
  }

  .wrap{position:relative; z-index:1; min-height:100%; display:flex; flex-direction:column}

  /* Static header + reveal accent bar */
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(10,10,16,.88);
    border-bottom:1px solid rgba(255,255,255,.08);
    backdrop-filter:blur(20px);
    box-shadow:0 18px 32px rgba(0,0,0,.45);
    transition:background .6s var(--ease), transform .6s var(--ease);
  }
  header::before{
    content:""; position:absolute; inset:0;
    background:linear-gradient(90deg, rgba(255,122,0,.16), transparent 60%);
    opacity:0; transition:opacity .5s var(--ease);
    pointer-events:none;
  }
  header::after{
    content:""; position:absolute; left:0; right:0; top:0; height:3px; opacity:0;
    background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(var(--accent-rgb),.95) 50%, rgba(255,255,255,0) 100%);
    background-size:200% 100%;
  }
  @keyframes sweep { to { background-position:200% 0; } }
  body.phase-open header::before{opacity:.6;}
  body.phase-revealed header::before{opacity:.3;}
  body.phase-open header::after{opacity:1; animation:sweep 1.8s linear infinite;}
  body.reveal-glow header::after{ opacity:1; animation: sweep 1.2s linear infinite; }
  body.phase-open header{background:rgba(18,12,20,.92); box-shadow:0 18px 42px rgba(255,122,0,.25);}
  body.phase-revealed header{background:rgba(22,12,6,.94); box-shadow:0 22px 46px rgba(255,122,0,.32);}
  body.phase-open .frame-vignette{opacity:.42;}
  body.phase-revealed .frame-vignette{opacity:.52;}

  .topbar{display:flex; align-items:center; gap:16px; padding:14px 20px; max-width:1100px; margin:0 auto; position:relative;}
  .brand{display:flex; align-items:center; gap:12px; filter:drop-shadow(0 8px 22px rgba(0,0,0,.45));}
  .brand img{height:42px; width:auto}
  .brand h1{margin:0; font-size:18px; text-transform:uppercase; letter-spacing:2.4px; color:var(--ink);}
  .brand h1 .dot{color:var(--accent)}
  .who{margin-left:8px; color:var(--muted); font-size:13px}
  .who a{color:var(--muted); text-decoration:underline dotted; cursor:pointer}

  nav{margin-left:auto; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .btn{
    position:relative;
    appearance:none;
    border:1px solid rgba(255,255,255,.12);
    background:radial-gradient(circle at top, rgba(23,23,32,.95), rgba(12,12,18,.9));
    color:var(--ink);
    padding:9px 14px;
    border-radius:12px;
    cursor:pointer;
    font-weight:700;
    letter-spacing:.3px;
    overflow:hidden;
    transition: transform .18s var(--ease), box-shadow .28s var(--ease), border-color .18s var(--ease), background .18s var(--ease);
    transform:perspective(360px) rotateX(var(--tilt-y)) rotateY(var(--tilt-x));
  }
  .btn::before{
    content:""; position:absolute; inset:-40% -40%; background:radial-gradient(120% 120% at calc(var(--glow-x)*1%) calc(var(--glow-y)*1%), rgba(255,122,0,.18), transparent 60%);
    opacity:0; transition:opacity .2s ease;
    pointer-events:none;
  }
  .btn::after{
    content:""; position:absolute; inset:-120% -12% auto auto; height:180%; width:42%;
    background:linear-gradient(180deg, rgba(255,255,255,.5), rgba(255,255,255,0));
    opacity:0; transform:rotate(18deg);
    transition:opacity .2s ease, transform .2s ease;
  }
  .btn.accent{
    background:linear-gradient(160deg, rgba(var(--accent-rgb),.96), rgba(196,68,0,.92));
    color:#110702;
    border-color:rgba(var(--accent-rgb),.55);
    box-shadow:0 12px 26px rgba(255,122,0,.25);
  }
  .btn.ghost{
    background:rgba(255,255,255,.04);
    color:var(--ink);
    border-color:rgba(255,255,255,.12);
  }
  .btn.small{padding:7px 11px; font-size:12px; font-weight:800; text-transform:uppercase; letter-spacing:1.4px;}
  .btn:hover{
    transform:translateY(-3px) scale(1.01);
    box-shadow:0 16px 34px rgba(0,0,0,.45);
    border-color:rgba(255,255,255,.18);
  }
  .btn:hover::after{opacity:.45; transform:rotate(10deg);}
  .btn:hover::before{opacity:.75;}
  .btn:focus-visible{ outline:2px solid var(--ring); outline-offset:2px; border-color:rgba(255,255,255,.3) }

  main{
    flex:1;
    width:100%;
    max-width:1100px;
    margin:28px auto 64px;
    padding:0 20px;
    position:relative;
    z-index:1;
    perspective:1200px;
    transform-style:preserve-3d;
  }
  main > section{
    margin:20px 0;
    transform:translateZ(calc(var(--scroll-depth)*-0.3px));
    transition:transform .6s var(--ease);
  }
  main > section.view-active{animation:viewFade .55s var(--ease);}
  .panel{
    --panel-raise:0px;
    --panel-scale:1;
    --panel-depth:calc(var(--scroll-depth)*-0.25px);
    background:linear-gradient(165deg, rgba(18,18,26,.96), rgba(6,6,10,.92));
    border:1px solid rgba(255,255,255,.09);
    border-radius:18px;
    padding:22px;
    margin:14px 0;
    box-shadow:0 28px 48px rgba(0,0,0,.45);
    transition:transform .45s var(--ease), box-shadow .45s var(--ease), border-color .45s var(--ease), backdrop-filter .45s var(--ease);
    position:relative;
    overflow:hidden;
    backdrop-filter:blur(18px);
    transform:translate3d(0,var(--panel-raise),0) scale(var(--panel-scale)) translateZ(var(--panel-depth));
  }
  .panel::before,
  .panel::after{
    content:"";
    position:absolute;
    pointer-events:none;
    transition:opacity .3s var(--ease), transform .3s var(--ease);
  }
  .panel::before{
    inset:-46% -28% auto auto;
    height:88%;
    width:58%;
    background:radial-gradient(circle at top, rgba(var(--accent-rgb),.2), rgba(255,255,255,0));
    opacity:.65;
    filter:blur(26px);
    animation:panelLight 8s ease-in-out infinite;
  }
  .panel::after{
    inset:auto -18% -52% auto;
    height:60%;
    width:40%;
    background:radial-gradient(circle at bottom, rgba(255,255,255,.08), rgba(255,255,255,0));
    opacity:.35;
    filter:blur(32px);
  }
  .panel:hover{
    --panel-raise:-8px;
    --panel-scale:1.015;
    box-shadow:0 44px 70px rgba(0,0,0,.55);
    border-color:rgba(255,255,255,.18);
    backdrop-filter:blur(20px);
  }
  .panel:hover::before{transform:translate(-8px,-10px); opacity:.9;}
  .panel h2{margin:0 0 12px 0; font-size:19px; letter-spacing:.45px;}
  .sub{color:var(--muted); margin-top:-2px; margin-bottom:14px}

  /* Neon underline (KG/ZS only) */
  body.neon-allowed h2, body.neon-allowed h3{ position:relative }
  body.neon-allowed h2::after, body.neon-allowed h3::after{
    content:""; position:absolute; left:0; bottom:-6px; height:2px; width:100%;
    background:linear-gradient(90deg, rgba(var(--accent-rgb),1), rgba(255,255,255,0) 70%);
    transform:scaleX(0); transform-origin:left; transition:transform .35s var(--ease), filter .35s var(--ease);
    filter:drop-shadow(0 0 6px rgba(255,122,0,.5));
  }
  body.neon-allowed h2:hover::after, body.neon-allowed h2:focus-within::after,
  body.neon-allowed h3:hover::after, body.neon-allowed h3:focus-within::after{ transform:scaleX(1) }

  .grid{display:grid; gap:12px}
  @media (min-width:900px){ .grid.cols-2{grid-template-columns:1fr 1fr} }

  input, select, textarea{
    width:100%;
    background:linear-gradient(160deg, rgba(16,16,24,.92), rgba(8,8,12,.85));
    color:var(--ink);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    padding:11px 14px;
    font:inherit;
    outline:none;
    transition:border-color .2s var(--ease), box-shadow .2s var(--ease), transform .2s var(--ease);
  }
  input:hover, select:hover, textarea:hover{
    border-color:rgba(255,255,255,.18);
  }
  input:focus-visible, select:focus-visible, textarea:focus-visible{
    outline:2px solid var(--ring);
    outline-offset:2px;
    border-color:rgba(var(--accent-rgb),.6);
    box-shadow:0 12px 24px rgba(0,0,0,.32);
  }
  textarea{min-height:136px; resize:vertical}
  label{display:block; margin:8px 0 6px; color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > *{flex:1}

  .muted{color:var(--muted)}
  .chip{
    display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
    border-radius:999px; border:1px solid rgba(255,255,255,.12); font-size:12px;
    background:rgba(255,255,255,.04);
    transition:transform .3s var(--ease), border-color .3s var(--ease), box-shadow .3s var(--ease);
  }
  .chip.ok{border-color:rgba(53,208,127,.4); color:#bff3d7; box-shadow:0 0 12px rgba(53,208,127,.15);}
  .chip.abs{border-color:rgba(239,71,111,.4); color:#ffc5d2; box-shadow:0 0 12px rgba(239,71,111,.12);}
  .chip:hover{transform:translateY(-2px);}
  .count-pop{animation:countPop .6s var(--ease);}

  .bar{
    height:12px;
    background:rgba(255,255,255,.06);
    border-radius:999px;
    overflow:hidden;
    outline:1px solid rgba(255,255,255,.08);
    position:relative;
  }
  .bar::after{
    content:""; position:absolute; inset:2px; border-radius:999px;
    background:linear-gradient(90deg, rgba(255,255,255,.12), transparent);
    opacity:.4;
  }
  .bar > span{
    display:block; height:100%; width:0%;
    background:linear-gradient(90deg, rgba(var(--accent-rgb),1), rgba(var(--accent-rgb),.45));
    transition:width .6s var(--ease);
    position:relative; z-index:1;
  }

  .phase{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px 16px;
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    background:linear-gradient(160deg, rgba(255,255,255,.05), rgba(0,0,0,.15));
    box-shadow:0 18px 36px rgba(0,0,0,.35);
  }
  .pill{
    font-weight:800;
    padding:5px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    letter-spacing:1.2px;
    text-transform:uppercase;
    font-size:12px;
  }
  .pill.open{
    background:rgba(255,122,0,.16);
    border-color:rgba(var(--accent-rgb),.5);
    color:#ffd7b3;
    box-shadow:0 0 0 1px rgba(var(--accent-rgb),.15), 0 0 20px rgba(var(--accent-rgb),.18);
    animation:phasePulse 2.6s ease-in-out infinite;
  }
  .pill.idle{background:rgba(255,255,255,.08); color:#ddd}
  .pill.closed{background:rgba(53,208,127,.18); color:#c9f3df; border-color:rgba(53,208,127,.45)}

  /* QR pulse while voting open; fade during drumroll */
  .qrbox{
    position:absolute;
    right:16px;
    top:56px;
    background:linear-gradient(160deg, rgba(13,13,20,.92), rgba(5,5,10,.88));
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    padding:12px;
    z-index:2;
    box-shadow:0 20px 40px rgba(0,0,0,.45);
    transition:opacity .35s var(--ease), transform .35s var(--ease), box-shadow .35s var(--ease), border-color .35s var(--ease);
  }
  .qrbox::after{
    content:""; position:absolute; inset:8px;
    border-radius:10px;
    border:1px solid rgba(255,122,0,.28);
    opacity:.4;
    pointer-events:none;
    box-shadow:0 0 22px rgba(255,122,0,.2);
  }
  @keyframes qrpulse{
    0%{ transform:scale(1); box-shadow:0 0 0 rgba(255,122,0,0); }
    50%{ transform:scale(1.04); box-shadow:0 0 26px rgba(255,122,0,.28); }
    100%{ transform:scale(1); box-shadow:0 0 0 rgba(255,122,0,0); }
  }
  .qrbox.pulse{ animation: qrpulse 2.2s ease-in-out infinite }
  .qrbox:hover{ transform:translateY(-6px) scale(1.02); box-shadow:0 26px 50px rgba(0,0,0,.55); border-color:rgba(255,255,255,.2); }
  body.reveal-glow .qrbox{ opacity:0 }

  /* Circular gauge */
  .gauge{
    width:200px; height:200px; border-radius:50%;
    background:
      radial-gradient(circle at center, rgba(255,255,255,.08), transparent 62%),
      conic-gradient(rgba(var(--accent-rgb),.88) calc(var(--p,0)*1%), rgba(255,255,255,.06) 0);
    display:grid; place-items:center; margin:8px auto 4px; box-shadow:0 6px 28px rgba(0,0,0,.28);
    transition:background .45s var(--ease), transform .45s var(--ease);
    position:relative;
  }
  .gauge.bump{animation:gaugeBump .6s var(--ease);}
  .gauge::before{
    content:""; position:absolute; inset:18px; border-radius:50%;
    border:1px dashed rgba(255,255,255,.12);
    opacity:.6;
  }
  .gauge::after{
    content: attr(data-label);
    width:136px; height:136px; border-radius:50%; background:var(--panel);
    display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size:26px; color:#fff; letter-spacing:.5px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);
  }
  .gauge-sub{ text-align:center; color:var(--muted); margin-top:8px; font-size:13px; letter-spacing:.8px; text-transform:uppercase; }

  @keyframes gaugeBump{
    0%{transform:scale(1);}
    40%{transform:scale(1.05);}
    100%{transform:scale(1);}
  }
  @keyframes panelLight{
    0%,100%{transform:translate3d(6%, -4%, 0) scale(1); opacity:.55;}
    50%{transform:translate3d(-10%, 12%, 0) scale(1.08); opacity:.95;}
  }
  @keyframes drumSweep{
    0%{transform:rotate(0deg);}
    100%{transform:rotate(360deg);}
  }
  @keyframes countPop{
    0%{transform:scale(1);}
    40%{transform:scale(1.28);}
    100%{transform:scale(1);}
  }
  @keyframes phasePulse{
    0%,100%{transform:translateY(0); box-shadow:0 0 0 1px rgba(var(--accent-rgb),.14), 0 0 18px rgba(var(--accent-rgb),.2);}
    50%{transform:translateY(-1px); box-shadow:0 0 0 3px rgba(var(--accent-rgb),.28), 0 0 30px rgba(var(--accent-rgb),.35);}
  }
  @keyframes rowRise{
    0%{opacity:0; transform:translate3d(0,18px,0);}
    100%{opacity:1; transform:translate3d(0,0,0);}
  }

  #teamTable tbody tr{
    transition:transform .35s var(--ease), box-shadow .35s var(--ease), background .35s var(--ease);
    background:rgba(255,255,255,.02);
  }
  #teamTable tbody tr td{
    padding:10px 14px;
    background:rgba(12,12,18,.55);
    border-radius:8px;
  }
  #teamTable tbody tr:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 24px rgba(0,0,0,.35);
    background:rgba(255,122,0,.08);
  }
  .row-enter{
    opacity:0;
    animation:rowRise .7s var(--ease) forwards;
    animation-delay:calc(var(--i,0) * 0.05s);
  }

  /* Drumroll */
  .confetti{position:fixed; pointer-events:none; z-index:6000; width:10px; height:16px; opacity:.95; will-change:transform, top, opacity; mix-blend-mode:screen;}
  .confetti.ribbon{border-radius:6px;}
  .confetti.spark{width:8px; height:8px; border-radius:50%; box-shadow:0 0 12px currentColor;}
  .confetti.star{clip-path:polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);} 
  .drumroll{position:fixed; inset:0; background:radial-gradient(120% 120% at 50% -10%, rgba(255,122,0,.15), transparent 50%), rgba(0,0,0,.92); z-index:5000; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:14px; text-align:center; backdrop-filter: blur(3px); overflow:hidden;}
  .drumroll::before,
  .drumroll::after{content:""; position:absolute; inset:-20%; pointer-events:none; opacity:.45;}
  .drumroll::before{background:conic-gradient(from 120deg, rgba(255,122,0,.25), transparent 40%, rgba(255,255,255,.18) 60%, transparent 90%); filter:blur(12px); animation:drumSweep 6s linear infinite;}
  .drumroll::after{background:radial-gradient(circle at center, rgba(255,122,0,.18), transparent 65%); filter:blur(40px); opacity:.35; animation:haloPulse 8s ease-in-out infinite;}
  .drumroll-text{font-size:32px; letter-spacing:4px; color:#ffe2c4; text-transform:uppercase; text-shadow:0 0 20px rgba(255,122,0,.45);}
  .drumroll-sub{font-size:14px; letter-spacing:1.6px; text-transform:uppercase; color:rgba(255,255,255,.6); margin-top:-6px;}
  .countdown{font-size:64px; font-weight:900; letter-spacing:4px}
  .drumroll-bar{width:min(520px, 86vw); height:14px; background:rgba(255,255,255,.1); border-radius:999px; overflow:hidden; outline:1px solid rgba(255,255,255,.15)}
  .drumroll-bar .bar-fill{height:100%; width:0%; background:linear-gradient(90deg, rgba(255,255,255,.35), rgba(var(--accent-rgb),.9)); transition:width 1s linear}

  /* Winner glass card */
  .glass-card{
    padding:16px 20px; border-radius:16px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.18);
    box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 12px rgba(255,255,255,.04);
    backdrop-filter: blur(10px) saturate(120%);
    -webkit-backdrop-filter: blur(10px) saturate(120%);
    position:relative;
    overflow:hidden;
  }
  .glass-card::before{
    content:""; position:absolute; inset:-40% 10% 60%; background:linear-gradient(120deg, rgba(255,255,255,.35), transparent 60%);
    opacity:.6; filter:blur(40px); transform:rotate(8deg);
  }
  .glass-card::after{
    content:""; position:absolute; inset:20px; border-radius:12px; border:1px solid rgba(255,255,255,.12); opacity:.35;
  }
  .winner-reveal{display:flex; flex-direction:column; align-items:center; gap:12px}
  .winner-title{font-size:22px; color:#ffd166; text-transform:uppercase; letter-spacing:3px}
  .winner-name{font-size:36px; font-weight:900; padding:10px 16px; border-radius:12px; background:rgba(0,0,0,.25); outline:1px solid rgba(255,255,255,.15)}
  .winner-burst{position:absolute; top:50%; left:50%; width:520px; height:520px; margin:-260px 0 0 -260px; border-radius:50%; background:radial-gradient(circle, rgba(255,122,0,.32), transparent 65%); filter:blur(40px); opacity:.55; animation:burstPulse 4s ease-in-out infinite alternate; z-index:-1;}
  @keyframes burstPulse{0%{transform:scale(.9); opacity:.45;}100%{transform:scale(1.1); opacity:.6;}}

  /* Ambient glow during reveal (Team View) */
  @keyframes glowPulse {
    0%{ box-shadow: 0 0 0 1px rgba(255,122,0,.25), 0 0 24px rgba(255,122,0,.35), inset 0 0 40px rgba(255,122,0,.12) }
    50%{ box-shadow: 0 0 0 1px rgba(255,122,0,.35), 0 0 40px rgba(255,122,0,.55), inset 0 0 60px rgba(255,122,0,.16) }
    100%{ box-shadow: 0 0 0 1px rgba(255,122,0,.25), 0 0 24px rgba(255,122,0,.35), inset 0 0 40px rgba(255,122,0,.12) }
  }
  body.reveal-glow #view-team { animation: glowPulse 1.4s ease-in-out infinite }

  @keyframes watermarkDrift{
    0%{ transform:translate3d(0,0,0) scale(1); opacity:.28; }
    40%{ transform:translate3d(-12px,8px,0) scale(1.04); opacity:.32; }
    70%{ transform:translate3d(14px,-10px,0) scale(.97); opacity:.24; }
    100%{ transform:translate3d(0,0,0) scale(1); opacity:.28; }
  }

  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.75); z-index:4500; backdrop-filter:blur(2px)}
  .modal.active{display:flex}
  .modal-card{background:#111; border:1px solid rgba(var(--accent-rgb),.35); border-radius:14px; width:min(440px,92vw); padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .modal-title{margin:0 0 10px 0; font-size:18px; color:var(--accent)}
  .modal-actions{display:flex; gap:10px; margin-top:10px}

  @media (prefers-reduced-motion: reduce){
    .bg-stars,.bg-halo,.wm,.panel::before,.panel::after,
    .boot-stars,.boot-intro,.boot-sigil,.boot-logo,.boot-crawl .crawl,
    .texture-noise,.frame-vignette,
    .qrbox,.qrbox::after,.gauge,.gauge.bump,
    .drumroll,.confetti,.boot,
    body.reveal-glow #view-team,
    .row-enter,.pill.open,
    .count-pop{animation:none !important;}
    .row-enter{opacity:1 !important;}
    .panel,.btn,.qrbox,.chip,#teamTable tbody tr{transition:none !important;}
    .panel:hover,.btn:hover,.qrbox:hover,#teamTable tbody tr:hover{transform:none !important; box-shadow:none !important;}
    body{--scroll-depth:0 !important; --scroll-ambient:0 !important;}
  }

  .hide{display:none !important}
</style>
</head>
<body>
<!-- Cinematic boot sequence -->
<div class="boot" id="boot" aria-hidden="true">
  <div class="boot-stars"></div>
  <div class="boot-vignette"></div>
  <div class="boot-frame">
    <div class="boot-intro">
      <p>Blacfox is known for outmanoeuvring the galaxy‚Äôs toughest marketing challenges.</p>
      <p>Every Friday, the most formidable squad in the sector reconvenes.</p>
    </div>
    <div class="boot-sigil">
      <img src="logo.png" alt="Blacfox logo">
    </div>
    <div class="boot-logo" aria-hidden="true">Blacfox <span>‚Ä¢</span> Star Player</div>
    <div class="boot-crawl">
      <div class="crawl">
        <span>Strategists forged in headline heat.</span>
        <span>Designers who bend light, pixels, and deadlines.</span>
        <span>Campaigns that conquer galaxies and quarterly targets alike.</span>
        <span>An unstoppable marketing force feared by the mediocre.</span>
        <span>Today we honor the team that keeps the hype engine roaring.</span>
      </div>
    </div>
  </div>
</div>

<!-- Ambient background layers -->
<div class="bg-layers" aria-hidden="true">
  <div class="bg-stars"></div>
  <div class="bg-halo"></div>
</div>

<!-- Watermark -->
<div class="wm" aria-hidden="true"></div>
<div class="texture-noise" aria-hidden="true"></div>
<div class="frame-vignette" aria-hidden="true"></div>

<div class="wrap" aria-live="polite">
  <header id="appHeader">
    <div class="topbar">
      <div class="brand">
        <img src="logo.png" alt="Blacfox logo" />
        <h1>Blacfox <span class="dot">‚Ä¢</span> Star Player</h1>
        <div class="who" id="whoAmIText"></div>
      </div>
      <nav>
        <button class="btn" id="teamNav" data-view="team">Team View</button>
        <button class="btn" id="voteNav" data-view="vote">Vote</button>
        <button class="btn ghost hide" id="adminNav" data-view="admin">Admin</button>
        <button class="btn ghost" id="soundToggle" title="Toggle sounds">üîä</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- TEAM VIEW -->
    <section id="view-team" class="panel">
      <div class="row" style="justify-content:flex-end; gap:8px; margin-top:-4px">
        <button class="btn small" id="fsToggle">Full Screen</button>
      </div>

      <h2>Team View</h2>

      <!-- QR to Vote (Observer only) -->
      <div class="qrbox hide" id="qrBox">
        <div id="qr"></div>
        <div class="muted" style="font-size:12px;margin-top:6px;text-align:center">Scan to vote</div>
      </div>

      <div id="phaseBanner" class="phase">
        <span id="phasePill" class="pill idle">Waiting</span>
        <span id="phaseText" class="muted">Waiting to begin‚Ä¶</span>
      </div>

      <!-- Observer tally panel -->
      <div id="observerTally" class="panel hide" style="text-align:center">
        <div id="obsGauge" class="gauge" data-label="0/0" style="--p:0;"></div>
        <div class="gauge-sub" id="obsSub">0 of 0 eligible votes cast</div>
      </div>

      <!-- KG tools + list/results (hidden for Observer) -->
      <div id="kgBlock" class="hide">
        <div class="row" style="gap:10px; flex-wrap:wrap; padding:10px; border-radius:12px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.12)">
          <span class="chip">Present: <b id="mdPresent">0</b></span>
          <span class="chip">Votes: <b id="mdVotes">0</b></span>
          <button class="btn small accent hide" id="btnStart">Start Voting</button>
          <button class="btn small accent hide" id="btnReveal">Reveal Winner</button>
          <button class="btn small accent hide" id="btnCloseReveal">Close & Reveal Now</button>
          <!-- PIN controls (KG only) -->
          <span id="pinPanel" class="hide" style="display:flex; align-items:center; gap:8px;">
            <label class="muted" style="display:flex; align-items:center; gap:6px">
              <input type="checkbox" id="pinEnable" /> Require PIN
            </label>
            <button class="btn small" id="pinGenerate">New PIN</button>
            <span class="chip" id="pinValue" title="Share this PIN with voters"></span>
          </span>
        </div>

        <div class="grid cols-2">
          <div class="panel">
            <h3>Attendance</h3>
            <div class="row">
              <div class="chip"><span>üë•</span><span id="t-total">0</span>&nbsp;Total</div>
              <div class="chip ok"><span>üü¢</span><span id="t-present">0</span>&nbsp;Present</div>
              <div class="chip abs"><span>üî¥</span><span id="t-absent">0</span>&nbsp;Absent</div>
              <div class="chip"><span>üó≥Ô∏è</span><span id="t-voted">0</span>&nbsp;Voted</div>
            </div>
            <div style="height:8px"></div>
            <table class="table" id="teamTable" style="width:100%; border-collapse:separate; border-spacing:0 8px">
              <thead><tr><th>Name</th><th>Initials</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="panel">
            <h3 id="resultsTitle">Results</h3>
            <div id="resultsHint" class="muted">Results are hidden until the winner is revealed.</div>
            <div id="teamBars" class="hide"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- VOTE (players + ZS; NOT KG/Observer) -->
    <section id="view-vote" class="panel hide">
      <h2>Vote</h2>
      <div class="sub">Confirm identity once (per tab). Pick a <strong>present</strong> teammate (not yourself) and submit.</div>

      <div class="grid cols-2">
        <div class="panel">
          <h3>Identity</h3>
          <div id="idStatus" class="muted">Not set</div>
          <div class="row" style="margin-top:10px">
            <button class="btn accent" id="openIdentity">Confirm identity</button>
            <button class="btn" id="clearIdentity">Clear</button>
          </div>
        </div>

        <div class="panel" id="votePanel">
          <h3>Ballot</h3>
          <div id="voteGuard" class="muted">Confirm your identity to proceed.</div>
          <div id="voteForm" class="hide">
            <label for="voteFor">I vote for</label>
            <select id="voteFor"></select>
            <div class="row" style="margin-top:10px">
              <button class="btn accent" id="submitVote">Submit vote</button>
            </div>
            <div id="voteMsg" class="muted" style="margin-top:10px"></div>
          </div>
        </div>
      </div>

      <!-- Player gauge -->
      <div class="panel" style="text-align:center">
        <div id="playerGauge" class="gauge" data-label="0/0" style="--p:0;"></div>
        <div class="gauge-sub" id="playerSub">0 of 0 eligible votes cast</div>
      </div>
    </section>

    <!-- ADMIN (ZS only ‚Äî password required) -->
    <section id="view-admin" class="panel hide">
      <h2>Admin</h2>
      <div class="sub">Visible only when you‚Äôre <strong>ZS</strong>.</div>

      <div class="grid cols-2">
        <div class="panel">
          <h3>Team Members</h3>
          <label for="teamArea">Format: <code>Full Name - XX</code> per line</label>
          <textarea id="teamArea" spellcheck="false"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn accent" id="saveTeam">Save Team</button>
            <button class="btn" id="resetSession">New Day</button>
          </div>
          <p class="muted" style="margin-top:8px">Saves to the session and locally for offline.</p>
          <div style="height:8px"></div>
          <label for="sessionInput">Session code (all devices must match)</label>
          <div class="row">
            <input id="sessionInput" placeholder="e.g. fox123" />
            <button class="btn" id="saveSessionCode">Use code</button>
          </div>
          <p class="muted" style="margin-top:6px">QR updates automatically (Observer-only).</p>
        </div>

        <div class="panel">
          <h3>Attendance</h3>
          <div id="adminAttendance"></div>
          <div style="height:8px"></div>
          <div id="adminMsg" class="muted" style="margin-top:10px"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Identity Modal -->
<div class="modal" id="idModal" aria-hidden="true">
  <div class="modal-card">
    <h3 class="modal-title">Confirm your identity</h3>
    <label for="idSelect">I am</label>
    <select id="idSelect"></select>
    <div class="modal-actions">
      <button class="btn" id="idCancel">Not now</button>
      <button class="btn accent" id="idOk">Confirm</button>
    </div>
    <p class="muted" style="margin-top:8px">Selecting your name also marks you present. You can also choose <b>Observer</b>.</p>
  </div>
</div>

<!-- ZS Password Modal -->
<div class="modal" id="pwModal" aria-hidden="true">
  <div class="modal-card">
    <h3 class="modal-title">Admin password (ZS)</h3>
    <input id="pwInput" type="password" placeholder="Enter password" />
    <div class="modal-actions">
      <button class="btn" id="pwCancel">Cancel</button>
      <button class="btn accent" id="pwOk">Unlock</button>
    </div>
    <p class="muted" id="pwMsg" style="margin-top:8px"></p>
  </div>
</div>

<!-- PIN Modal -->
<div class="modal" id="pinModal" aria-hidden="true">
  <div class="modal-card">
    <h3 class="modal-title">Enter session PIN</h3>
    <div class="row">
      <input id="pinInput" inputmode="numeric" maxlength="6" placeholder="4‚Äì6 digits" />
    </div>
    <div class="modal-actions">
      <button class="btn" id="pinCancel">Cancel</button>
      <button class="btn accent" id="pinOk">Unlock voting</button>
    </div>
    <p class="muted" id="pinMsg" style="margin-top:8px"></p>
  </div>
</div>

<!-- QR -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
/* ====== CONFIG (Firebase) ====== */
window.BF_SYNC = {
  provider: 'firebase',
  sessionId: 'demo',
  firebaseConfig: {
    apiKey: "AIzaSyCPowEBl-_CSqIObkgddFD2ZrvcXS4DsO4",
    authDomain: "bf-star-player.firebaseapp.com",
    databaseURL: "https://bf-star-player-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bf-star-player",
    storageBucket: "bf-star-player.firebasestorage.app",
    messagingSenderId: "225126593395",
    appId: "1:225126593395:web:e3e70364b8fef101f9cb06",
    measurementId: "G-RPHVLD60B1"
  }
};

/* ====== Keys & defaults ====== */
const LS = { team:'bf_team', votes:'bf_votes', voted:'bf_voted_by', user:'bf_current_user', phase:'bf_phase', theme:'bf_theme', session:'bf_session', pinok:'bf_pinok_', drum:'bf_drum_seen_', snd:'bf_sounds' };

const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

const DEFAULT_MEMBERS = [
  {name:'Olwethu',     initials:'OB', status:'absent'},
  {name:'Christopher', initials:'CB', status:'absent'},
  {name:'Malaika',     initials:'MR', status:'absent'},
  {name:'Amilio',      initials:'AB', status:'absent'},
  {name:'Zubair',      initials:'ZS', status:'absent'},
  {name:'Amjad',       initials:'AZ', status:'absent'},
  {name:'Jerome',      initials:'JM', status:'absent'},
  {name:'Emilio',      initials:'ED', status:'absent'},
  {name:'Benita',      initials:'BJ', status:'absent'},
  {name:'Jaydon',      initials:'JV', status:'absent'},
  {name:'Stehpan',     initials:'SE', status:'absent'},
  {name:'Kerushan',    initials:'KG', status:'absent'},
  {name:'Payal',       initials:'PS', status:'absent'},
  {name:'Yudhveer',    initials:'YM', status:'absent'},
  {name:'Rinolan',     initials:'RR', status:'absent'},
  {name:'Fhad',        initials:'FW', status:'absent'},
  {name:'Brendon',     initials:'BS', status:'absent'},
];

/* ====== Local mirrors ====== */
function loadTeamLocal(){ const raw = localStorage.getItem(LS.team); const t = raw?JSON.parse(raw):DEFAULT_MEMBERS.slice(); return t.map(m=>({name:''+m.name, initials:(''+m.initials).toUpperCase(), status:m.status==='present'?'present':'absent'})); }
function saveTeamLocal(t){ localStorage.setItem(LS.team, JSON.stringify(t)); }
function loadVotesLocal(){ return JSON.parse(localStorage.getItem(LS.votes)||'{}'); }
function saveVotesLocal(v){ localStorage.setItem(LS.votes, JSON.stringify(v)); }
function loadVotedLocal(){ return JSON.parse(localStorage.getItem(LS.voted)||'[]'); }
function saveVotedLocal(a){ localStorage.setItem(LS.voted, JSON.stringify(a)); }

function getUser(){ return sessionStorage.getItem(LS.user) || ''; }
function setUser(i){ if(i) sessionStorage.setItem(LS.user, i); else sessionStorage.removeItem(LS.user); updateNav(); }

function getPhaseLocal(){ return localStorage.getItem(LS.phase) || 'not_started'; }
function setPhaseLocal(p){ localStorage.setItem(LS.phase, p); renderPhase(); renderTeam(); renderMd(); renderVote(); renderObserverTally(); renderPlayerGauge(); }

/* ====== State ====== */
let teamMembers = loadTeamLocal();
let votes = loadVotesLocal();
let votedInitials = loadVotedLocal();
let sessionId = (new URLSearchParams(location.search).get('s')) || localStorage.getItem(LS.session) || (window.BF_SYNC && window.BF_SYNC.sessionId) || 'demo';
localStorage.setItem(LS.session, sessionId);
let sessionPin = '';
let pinEnabled = false;
let lastDrumSeen = Number(localStorage.getItem(LS.drum + sessionId) || 0);
let soundsEnabled = localStorage.getItem(LS.snd) !== '0';

/* ====== Firebase Sync ====== */
const SYNC = (()=>{
  let enabled = false, db=null, rootRef=null; const listeners=[];
  function init(){
    const cfg = window.BF_SYNC || {};
    if(!cfg.firebaseConfig || !cfg.sessionId){ return; }
    try{ firebase.apps.length ? firebase.app() : firebase.initializeApp(cfg.firebaseConfig); }catch(e){}
    db = firebase.database(); setSession(cfg.sessionId || 'demo');
  }
  function setSession(id){
    detach(); sessionId = id || 'demo'; localStorage.setItem(LS.session, sessionId);
    rootRef = db.ref('sessions/'+sessionId); enabled = true;
    attach(rootRef.child('phase'), s=> { if(s.exists()) setPhaseLocal(s.val()); });
    attach(rootRef.child('team'),  s=> { teamMembers = s.val() || DEFAULT_MEMBERS.slice(); saveTeamLocal(teamMembers); renderCore(); });
    attach(rootRef.child('votes'), s=> { votes = s.val() || {}; saveVotesLocal(votes); renderTeam(); renderMd(); renderObserverTally(); renderPlayerGauge(); });
    attach(rootRef.child('votedBy'), s=> { votedInitials = Object.keys(s.val()||{}); saveVotedLocal(votedInitials); renderTeam(); renderMd(); renderVote(); renderObserverTally(); renderPlayerGauge(); });
    attach(rootRef.child('pin'), s=> { sessionPin = (s.val() || '').toString(); updatePinUi(); });
    attach(rootRef.child('pinEnabled'), s=> { pinEnabled = !!s.val(); updatePinUi(); renderVote(); });
    attach(rootRef.child('revealStartAt'), s=> { const ts = Number(s.val()||0); if(ts && ts!==lastDrumSeen){ lastDrumSeen = ts; localStorage.setItem(LS.drum + sessionId, String(ts)); revealOverlaySync(ts); } });
    rootRef.once('value').then(s=>{
      if(!s.child('team').exists()) rootRef.child('team').set(teamMembers);
      if(!s.child('votes').exists()) rootRef.child('votes').set(votes);
      if(!s.child('votedBy').exists()) rootRef.child('votedBy').set({});
      if(!s.child('phase').exists()) rootRef.child('phase').set(getPhaseLocal());
      if(!s.child('pinEnabled').exists()) rootRef.child('pinEnabled').set(false);
    }).catch(console.warn);
  }
  function attach(ref, fn){ ref.on('value', fn); listeners.push({ref, fn}); }
  function detach(){ listeners.forEach(({ref, fn})=> ref.off('value', fn)); listeners.length=0; }

  function setPhase(p){ if(!enabled) return setPhaseLocal(p); return rootRef.child('phase').set(p); }
  function saveTeam(t){ if(!enabled){ saveTeamLocal(t); renderCore(); return; } return rootRef.child('team').set(t); }
  function resetSessionAndAttendance(){
    const cleared = teamMembers.map(m=>({name:m.name, initials:m.initials, status:'absent'}));
    if(!enabled){
      teamMembers = cleared; saveTeamLocal(teamMembers);
      votes={}; votedInitials=[]; saveVotesLocal(votes); saveVotedLocal(votedInitials); setPhaseLocal('not_started'); renderCore(); return;
    }
    return rootRef.update({ votes:{}, votedBy:{}, phase:'not_started', revealStartAt:null, team: cleared });
  }
  function generatePin(){ return rootRef.child('pin').set((''+Math.floor(1000 + Math.random()*9000))); }
  function setPinEnabled(on){ return rootRef.child('pinEnabled').set(!!on); }
  async function voteTransaction(voterInitials, pickInitials){
    if(!enabled){
      if(votedInitials.includes(voterInitials)) throw new Error('already_voted');
      votes[pickInitials]=(votes[pickInitials]||0)+1; votedInitials.push(voterInitials);
      saveVotesLocal(votes); saveVotedLocal(votedInitials); renderTeam(); renderMd(); renderVote(); renderObserverTally(); renderPlayerGauge(); return;
    }
    const claimRef = rootRef.child('votedBy/'+voterInitials);
    const res = await claimRef.transaction(curr => curr ? curr : true);
    if(!res.committed){ throw new Error('already_voted'); }
    await rootRef.child('votes/'+pickInitials).transaction(curr => (curr||0)+1);
    renderVote();
  }
  async function triggerReveal(){
    if(!enabled){ setPhaseLocal('revealed'); revealOverlaySync(Date.now()); return; }
    await rootRef.update({ phase:'revealed', revealStartAt: firebase.database.ServerValue.TIMESTAMP });
  }
  return { init, setSession, setPhase, saveTeam, resetSessionAndAttendance, generatePin, setPinEnabled, voteTransaction, triggerReveal, get enabled(){ return enabled; } };
})();

function ensurePromise(res){
  return (res && typeof res.then === 'function') ? res : Promise.resolve(res);
}

/* ====== Web Audio: drumroll + chime ====== */
let audioCtx=null, drumGain=null, drumOsc=null, drumNoise=null, drumFilter=null;
function ensureAudio(){ if(audioCtx) return audioCtx; audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
function startDrumroll(){
  if(localStorage.getItem(LS.snd)==='0') return;
  const ctx = ensureAudio();
  const bufferSize = 2 * ctx.sampleRate;
  const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;

  drumNoise = ctx.createBufferSource(); drumNoise.buffer = noiseBuffer; drumNoise.loop = true;
  drumFilter = ctx.createBiquadFilter(); drumFilter.type='bandpass'; drumFilter.frequency.value=120; drumFilter.Q.value=0.9;

  const trem = ctx.createOscillator(); trem.type='sine'; trem.frequency.setValueAtTime(14, ctx.currentTime);
  const tremGain = ctx.createGain(); tremGain.gain.value = 0.6; trem.connect(tremGain.gain);

  drumGain = ctx.createGain(); drumGain.gain.value = 0.0001;
  drumNoise.connect(drumFilter); drumFilter.connect(drumGain); drumGain.connect(ctx.destination);

  drumOsc = ctx.createOscillator(); drumOsc.type='sine'; drumOsc.frequency.value=80;
  const oscGain = ctx.createGain(); oscGain.gain.value=0.02; drumOsc.connect(oscGain); oscGain.connect(drumGain);

  trem.connect(drumGain.gain);

  const now = ctx.currentTime;
  drumGain.gain.cancelScheduledValues(now);
  drumGain.gain.setValueAtTime(0.0001, now);
  drumGain.gain.exponentialRampToValueAtTime(0.25, now + 9.6); // slightly longer ramp for crescendo

  drumNoise.start(); drumOsc.start(); trem.start();
  setTimeout(()=>stopDrumroll(false), 12000);
}
function stopDrumroll(playChime=true){
  if(!audioCtx) return;
  const now = audioCtx.currentTime;
  if(drumGain){
    try{ drumGain.gain.cancelScheduledValues(now); drumGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.2); }catch{}
  }
  setTimeout(()=>{
    try{ drumNoise && drumNoise.stop(); drumOsc && drumOsc.stop(); }catch{}
    drumNoise=drumOsc=drumGain=drumFilter=null;
    if(playChime) chime();
  }, 220);
}
function chime(){
  if(localStorage.getItem(LS.snd)==='0') return;
  const ctx = ensureAudio();
  const g = ctx.createGain(); g.gain.value=0.0001; g.connect(ctx.destination);
  const o1 = ctx.createOscillator(); o1.type='triangle'; o1.frequency.value=880;
  const o2 = ctx.createOscillator(); o2.type='triangle'; o2.frequency.value=1320;
  o1.connect(g); o2.connect(g);
  const now = ctx.currentTime;
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.25, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+0.8);
  o1.start(now); o2.start(now);
  o1.stop(now+0.85); o2.stop(now+0.85);
}

/* ====== Helpers & UI ====== */
const motionState = { raf:null, scrollRaf:null };
function initAmbientMotion(){
  if(prefersReducedMotion) return;
  const layers = document.querySelector('.bg-layers');
  const update = (e)=>{
    const x = e.clientX || e.touches?.[0]?.clientX || window.innerWidth/2;
    const y = e.clientY || e.touches?.[0]?.clientY || window.innerHeight/2;
    const xp = Math.max(0, Math.min(100, (x / window.innerWidth) * 100));
    const yp = Math.max(0, Math.min(100, (y / window.innerHeight) * 100));
    document.body.style.setProperty('--glow-x', xp.toFixed(2));
    document.body.style.setProperty('--glow-y', yp.toFixed(2));
    if(layers){
      layers.style.setProperty('--parallax-x', xp.toFixed(2));
      layers.style.setProperty('--parallax-y', yp.toFixed(2));
    }
  };
  const throttled = (e)=>{
    if(motionState.raf) cancelAnimationFrame(motionState.raf);
    motionState.raf = requestAnimationFrame(()=>update(e));
  };
  window.addEventListener('pointermove', throttled);
  window.addEventListener('touchmove', throttled, { passive:true });
}
function attachButtonTilt(root=document){
  if(prefersReducedMotion) return;
  root.querySelectorAll('.btn').forEach(btn=>{
    if(btn.dataset.tiltReady) return;
    btn.dataset.tiltReady = '1';
    const reset = ()=>{
      btn.style.setProperty('--tilt-x', '0deg');
      btn.style.setProperty('--tilt-y', '0deg');
      btn.style.setProperty('--glow-x', '50');
      btn.style.setProperty('--glow-y', '50');
    };
    btn.addEventListener('pointermove', ev=>{
      const rect = btn.getBoundingClientRect();
      const relX = (ev.clientX - rect.left) / rect.width;
      const relY = (ev.clientY - rect.top) / rect.height;
      const tiltX = (relX - 0.5) * 10;
      const tiltY = (0.5 - relY) * 10;
      btn.style.setProperty('--tilt-x', `${tiltX.toFixed(2)}deg`);
      btn.style.setProperty('--tilt-y', `${tiltY.toFixed(2)}deg`);
      btn.style.setProperty('--glow-x', `${(relX*100).toFixed(2)}`);
      btn.style.setProperty('--glow-y', `${(relY*100).toFixed(2)}`);
    });
    btn.addEventListener('pointerleave', reset);
    btn.addEventListener('pointerup', reset);
    btn.addEventListener('blur', reset);
  });
}
function initScrollDepth(){
  if(prefersReducedMotion) return;
  const apply = ()=>{
    const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
    const depth = Math.min(60, scrollY * 0.08);
    const ambient = Math.min(80, scrollY * 0.12);
    document.body.style.setProperty('--scroll-depth', depth.toFixed(2));
    document.body.style.setProperty('--scroll-ambient', ambient.toFixed(2));
  };
  apply();
  window.addEventListener('scroll', ()=>{
    if(motionState.scrollRaf) cancelAnimationFrame(motionState.scrollRaf);
    motionState.scrollRaf = requestAnimationFrame(apply);
  }, { passive:true });
}
function setCount(el, value){
  if(!el) return;
  const str = String(value);
  if(el.textContent === str) return;
  el.textContent = str;
  if(prefersReducedMotion) return;
  el.classList.remove('count-pop');
  void el.offsetWidth;
  el.classList.add('count-pop');
}
function animateRows(rows){
  if(prefersReducedMotion) return;
  rows.forEach((row, idx)=>{
    row.style.setProperty('--i', idx);
    row.classList.remove('row-enter');
    void row.offsetWidth;
    row.classList.add('row-enter');
  });
}

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const ESC_MAP = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
const esc = s => String(s).replace(/[&<>"']/g, c => ESC_MAP[c]);
function resultsData(){ return teamMembers.map(m=>({ name:m.name, initials:m.initials, votes:Number(votes[m.initials]||0) })).sort((a,b)=>b.votes-a.votes||a.name.localeCompare(b.name)); }
function tallies(){
  let present=0, eligible=0;
  for(const m of teamMembers){
    if(m.status==='present'){
      present++;
      if(m.initials!=='KG') eligible++;
    }
  }
  const voted = new Set(votedInitials).size;
  return { total:teamMembers.length, present, eligible, absent:teamMembers.length-present, voted };
}
function renderCore(){ renderPhase(); renderTeam(); renderMd(); renderVote(); renderObserverTally(); renderPlayerGauge(); }
function renderAll(){ renderCore(); ensureQr(); }

function showView(id){
  const u = getUser();
  if(id==='team' && !['KG','ZS','OBSERVER'].includes(u)){
    alert('Team View is only available to KG, ZS, or Observer.');
    id='vote';
  }
  if(id==='admin' && u!=='ZS'){ id='vote'; }
  $$('main > section').forEach(s=>s.classList.add('hide'));
  $('#view-'+id).classList.remove('hide');
  if(id==='team'){ renderCore(); ensureQr(); }
  if(id==='vote'){ renderVote(); }
  if(id==='admin'){ renderAdmin(); }
}

/* Nav + visibility */
function updateNav(){
  const u = getUser();
  document.body.classList.toggle('neon-allowed', u==='KG' || u==='ZS');
  $('#whoAmIText').innerHTML = !u ? `<a id="changeId">Set identity</a>` : (u==='OBSERVER' ? `You are: Observer (<a id="changeId">change</a>)` : `You are: ${u} (<a id="changeId">change</a>)`);
  const canTeam = ['KG','ZS','OBSERVER'].includes(u);
  const isZS = u==='ZS';
  const isKG = u==='KG';
  $('#teamNav').classList.toggle('hide', !canTeam);
  $('#adminNav').classList.toggle('hide', !isZS);
  // Vote console visible to all except KG and Observer
  $('#voteNav').classList.toggle('hide', isKG || u==='OBSERVER');
  const link = $('#changeId'); if(link) link.addEventListener('click', e=>{ e.preventDefault(); openIdentityModal(); });

  // sound toggle icon state
  $('#soundToggle').textContent = (localStorage.getItem(LS.snd) === '0') ? 'üîá' : 'üîä';
}

/* TEAM VIEW */
function renderPhase(){
  const p = getPhaseLocal();
  const pill = $('#phasePill'), text = $('#phaseText');
  document.body.classList.toggle('phase-wait', p==='not_started');
  document.body.classList.toggle('phase-open', p==='open');
  document.body.classList.toggle('phase-revealed', p==='revealed');
  if(p==='not_started'){ pill.className='pill idle'; pill.textContent='Waiting'; text.textContent='Waiting to begin‚Ä¶'; }
  else if(p==='open'){ pill.className='pill open'; pill.textContent='Voting'; text.textContent='Voting still in progress'; }
  else { pill.className='pill closed'; pill.textContent='Closed'; text.textContent='Winner revealed'; }
  if(!prefersReducedMotion && pill){
    pill.classList.remove('count-pop');
    void pill.offsetWidth;
    pill.classList.add('count-pop');
  }
  const revealed = p==='revealed';
  $('#resultsHint').classList.toggle('hide', revealed);
  $('#teamBars').classList.toggle('hide', !revealed);
  $('#resultsTitle').textContent = revealed ? 'Results' : 'Results (hidden)';

  // QR pulse while open (Observer only)
  const qb = $('#qrBox');
  if(qb){ qb.classList.toggle('pulse', p==='open' && getUser()==='OBSERVER'); }
}

function renderTeam(){
  const u = getUser();
  const {total, present, absent, voted} = tallies();
  $('#kgBlock').classList.toggle('hide', u==='OBSERVER');
  $('#observerTally').classList.toggle('hide', u!=='OBSERVER');

  setCount($('#t-total'), total);
  setCount($('#t-present'), present);
  setCount($('#t-absent'), absent);
  setCount($('#t-voted'), voted);

  const tb = $('#teamTable tbody');
  if(tb){
    tb.innerHTML = teamMembers.map(m=>`<tr><td>${esc(m.name)}</td><td><strong>${esc(m.initials)}</strong></td><td>${m.status==='present'?'<span class="chip ok">Present</span>':'<span class="chip abs">Absent</span>'}</td></tr>`).join('');
    animateRows(tb.querySelectorAll('tr'));
  }

  const bars = $('#teamBars');
  if(bars){
    const data = resultsData(), max = Math.max(1, ...data.map(d=>d.votes));
    bars.innerHTML = data.map(d=>`<div style="margin:10px 0">
      <div class="row" style="align-items:center">
        <div style="font-weight:800;">${esc(d.name)} <span class="muted">(${esc(d.initials)})</span></div>
        <div style="margin-left:auto" class="chip">${d.votes} vote${d.votes===1?'':'s'}</div>
      </div>
      <div class="bar"><span style="width:${Math.round((d.votes/max)*100)}%"></span></div>
    </div>`).join('');
  }
}

function updatePinUi(){
  const show = getUser()==='KG';
  $('#pinPanel').classList.toggle('hide', !show);
  if(!show) return;
  $('#pinEnable').checked = !!pinEnabled;
  $('#pinValue').textContent = pinEnabled ? `PIN: ${sessionPin||'‚Äî'}` : 'PIN disabled';
}

function renderMd(){
  const isKG = getUser()==='KG';
  $('#kgBlock').classList.toggle('hide', !isKG && getUser()!=='ZS' ? true : false);
  if(!isKG) return;
  const {present, eligible, voted} = tallies();
  setCount($('#mdPresent'), present);
  setCount($('#mdVotes'), voted);
  const ph = getPhaseLocal();
  $('#btnStart').classList.toggle('hide', ph!=='not_started');
  $('#btnReveal').classList.toggle('hide', ph!=='open');
  const shouldSuggest = ph==='open' && voted >= Math.max(0, eligible - 1);
  $('#btnCloseReveal').classList.toggle('hide', !shouldSuggest);
  const btnStart = $('#btnStart');
  const btnReveal = $('#btnReveal');
  const btnClose = $('#btnCloseReveal');
  if(btnStart){ btnStart.disabled = ph!=='not_started'; }
  if(btnReveal){ btnReveal.disabled = ph!=='open'; }
  if(btnClose){ btnClose.disabled = ph!=='open'; }
  updatePinUi();
}
function mdReveal(){ SYNC.triggerReveal(); }

/* Observer tally gauge */
function renderObserverTally(){
  const u = getUser(); if(u!=='OBSERVER') return;
  const {eligible, voted} = tallies();
  const pct = eligible? Math.min(100, Math.round((voted/eligible)*100)) : 0;
  const g = $('#obsGauge'); const sub = $('#obsSub');
  if(g){
    g.style.setProperty('--p', pct);
    g.setAttribute('data-label', `${voted}/${eligible}`);
    if(g.dataset.prevVotes !== String(voted)){
      g.classList.remove('bump');
      void g.offsetWidth;
      g.classList.add('bump');
      g.dataset.prevVotes = String(voted);
    }
  }
  if(sub){ sub.textContent = `${voted} of ${eligible} eligible votes cast`; }
}

/* Player gauge */
function renderPlayerGauge(){
  const {eligible, voted} = tallies();
  const pct = eligible? Math.min(100, Math.round((voted/eligible)*100)) : 0;
  const g = $('#playerGauge'); const sub = $('#playerSub');
  if(g){
    g.style.setProperty('--p', pct);
    g.setAttribute('data-label', `${voted}/${eligible}`);
    if(g.dataset.prevVotes !== String(voted)){
      g.classList.remove('bump');
      void g.offsetWidth;
      g.classList.add('bump');
      g.dataset.prevVotes = String(voted);
    }
  }
  if(sub){ sub.textContent = `${voted} of ${eligible} eligible votes cast`; }
}

/* QR (Observer only) */
function ensureQr(){
  const holder = $('#qr'); const box = $('#qrBox'); if(!holder || !box) return;
  const isObs = getUser()==='OBSERVER';
  box.classList.toggle('hide', !isObs);
  if(!isObs) return;
  holder.innerHTML = '';
  const base = location.href.split('#')[0].split('?')[0];
  const url = `${base}?s=${encodeURIComponent(sessionId)}#view-vote`;
  try{ if(window.QRCode){ new QRCode(holder, {text:url, width:128, height:128, correctLevel: QRCode.CorrectLevel.M}); } else { holder.innerHTML = `<a href="${url}" class="muted" style="font-size:12px">Open Vote</a>`; } }
  catch{ holder.innerHTML = `<a href="${url}" class="muted" style="font-size:12px">Open Vote</a>`; }
}

/* Confetti */
function confettiMultiplier(){ if(prefersReducedMotion) return 0; const cores = navigator.hardwareConcurrency || 4; return cores <= 4 ? 0.6 : 1; }
function spawnConfetti(opts={}){ const el = document.createElement('div'); el.className='confetti';
  const colors = ['#ffffff','#ffe8cc','#ffb26a','#ff7a00','#ffd166'];
  const shapes = ['ribbon','spark','star'];
  const shape = shapes[Math.floor(Math.random()*shapes.length)];
  el.classList.add(shape);
  const color = colors[Math.floor(Math.random()*colors.length)];
  const half = opts.half || 'full';
  const left = half==='left' ? Math.random()*45 : half==='right' ? 55+Math.random()*45 : Math.random()*100;
  const size = 6 + Math.random()*10;
  const rot = Math.random()*360;
  const dur = 3 + Math.random()*2;
  let width = size;
  let height = size*1.6;
  let extra = '';
  if(shape==='ribbon'){
    width = size+4;
    height = size*2.1;
    extra = `background:linear-gradient(135deg, ${color}, rgba(255,255,255,.65)); box-shadow:0 0 12px rgba(255,122,0,.25); border-radius:6px;`;
  }else if(shape==='spark'){
    width = height = size;
    extra = `background:${color}; filter:blur(.2px) drop-shadow(0 0 8px ${color});`;
  }else{
    width = size+2;
    height = size+2;
    extra = `background:${color}; filter:drop-shadow(0 0 10px rgba(255,255,255,.3));`;
  }
  el.style.cssText = `left:${left}vw;top:-20px;width:${width}px;height:${height}px;transform:rotate(${rot}deg);opacity:.95;transition:transform ${dur}s cubic-bezier(.2,.9,.2,1.05), top ${dur}s cubic-bezier(.2,.9,.2,1.05), opacity ${dur}s linear;${extra}`;
  document.body.appendChild(el);
  requestAnimationFrame(()=>{
    el.style.top = '110vh';
    const dir = half==='left' ? (20+Math.random()*60) : half==='right' ? -(20+Math.random()*60) : ((Math.random()*2-1)*120);
    const twist = rot + 600 + Math.random()*260;
    el.style.transform = `translateX(${dir}px) rotate(${twist}deg)`;
    el.style.opacity = .1;
  });
  setTimeout(()=> el.remove(), dur*1000 + 500);
}

/* Drumroll overlay ‚Äî synced via revealStartAt */
function revealOverlaySync(serverTs){
  const now = Date.now();
  let remain = Math.max(0, Math.ceil(10 - (now - serverTs)/1000));
  const o = document.createElement('div'); o.className='drumroll';
  o.innerHTML = `<div class="drumroll-text">Drum roll‚Ä¶</div><div class="drumroll-sub">Winner reveal incoming</div><div class="countdown" id="dr-count">${remain}</div><div class="drumroll-bar"><div class="bar-fill" id="dr-fill" style="width:${(10-remain)*10}%"></div></div>`;
  document.body.appendChild(o);

  // Start audio + glow
  document.body.classList.add('reveal-glow');
  startDrumroll();

  const data = resultsData();
  const top = Math.max(0, ...data.map(d=>d.votes));
  const winners = data.filter(d=>d.votes===top);
  const fill = o.querySelector('#dr-fill'); const num = o.querySelector('#dr-count');

  const timer = setInterval(()=>{
    remain -= 1; if(remain<0) remain=0;
    num.textContent = remain; fill.style.width = `${(10-remain)*10}%`;

    // Crescendo confetti in the last 2 seconds
    if(remain === 2 || remain === 1){
      const mult = confettiMultiplier();
      for(let i=0;i<Math.round(24*mult);i++) spawnConfetti();
    }

    if(remain<=0){ clearInterval(timer);
      stopDrumroll(true);
      const co = winners.length>1;
      o.innerHTML = `<div class="winner-burst" aria-hidden="true"></div><div class="glass-card winner-reveal">${co?'<div class="winner-title">Co-Winners</div>':'<div class="winner-title">Star Player</div>'}<div class="winner-name">${winners.map(w=>w.name).join(co?' ‚Ä¢ ':' & ')}</div></div>`;
      const mult = confettiMultiplier(); const count = Math.round((co?120:150) * mult);
      if(mult>0){ for(let i=0;i<count;i++) spawnConfetti(co?{half:i%2===0?'left':'right'}:{}); }
      setTimeout(()=>{ o.remove(); document.body.classList.remove('reveal-glow'); }, 6000);
    }
  },1000);
}

/* Vote UI + PIN gate */
function renderVote(){
  const u = getUser();
  $('#idStatus').textContent = u ? (u==='OBSERVER' ? 'Confirmed as Observer' : `Confirmed as ${u}`) : 'Not set';

  const guard = $('#voteGuard'), form  = $('#voteForm'), msg = $('#voteMsg');
  const showBlock = (text) => { guard.textContent = text; guard.classList.remove('hide'); form.classList.add('hide'); msg.textContent = ''; };
  const showForm  = () => { guard.classList.add('hide'); form.classList.remove('hide'); };

  if(!u){ showBlock('Confirm your identity to proceed.'); return; }
  if(u==='OBSERVER'){ showBlock('Observer mode: voting unavailable.'); return; }
  if(u==='KG'){ showBlock('Hi KG. Use Team View to start voting and reveal the winner.'); return; }

  const ph = getPhaseLocal();
  if(ph==='not_started'){ showBlock('Voting has not started yet. Ask KG to press ‚ÄúStart Voting‚Äù.'); return; }
  if(ph==='revealed'){ showBlock('Voting is closed.'); return; }
  if(votedInitials.includes(u)){ showBlock('You have already voted this session.'); return; }

  const pinOk = localStorage.getItem(LS.pinok + sessionId) === '1';
  if(SYNC.enabled && pinEnabled && !pinOk){ openPinModal(); showBlock('Enter the session PIN to unlock voting.'); return; }

  const presentChoices = teamMembers.filter(m=>m.status==='present' && m.initials!==u);
  if(presentChoices.length === 0){ showBlock('No present teammates to vote for.'); return; }

  $('#voteFor').innerHTML = '<option value="">Select a teammate‚Ä¶</option>' + presentChoices.map(m=>`<option value="${esc(m.initials)}">${esc(m.name)} ‚Äî ${esc(m.initials)}</option>`).join('');
  showForm();
}
async function voteSubmit(){
  const u = getUser(), msg = $('#voteMsg');
  const sel = ($('#voteFor').value||'').trim().toUpperCase();
  if(!u){ msg.textContent='Confirm identity first.'; return; }
  if(getPhaseLocal()!=='open'){ msg.textContent='Voting is not open.'; return; }
  if(votedInitials.includes(u)){ msg.textContent='You have already voted.'; return; }
  if(!sel){ msg.textContent='Select your pick from the dropdown.'; return; }
  if(sel===u){ msg.textContent='Self-votes are not allowed.'; return; }
  const pickRec = teamMembers.find(t=>t.initials===sel && t.status==='present'); if(!pickRec){ msg.textContent='Selected teammate is not present.'; return; }
  try{
    await SYNC.voteTransaction(u, sel);
    renderVote();
    msg.textContent = 'Vote recorded. Thank you!';
    for(let i=0;i<Math.round(16*confettiMultiplier());i++) spawnConfetti();
  }catch(e){ msg.textContent = e && e.message==='already_voted' ? 'You have already voted.' : 'Could not submit vote. Please try again.'; }
}

/* Identity modal */
let pendingZS = false;
function openIdentityModal(){
  const idSel = $('#idSelect'), u = getUser();
  idSel.innerHTML = [`<option value="">Select your name‚Ä¶</option>`,
    `<option value="OBSERVER"${u==='OBSERVER'?' selected':''}>Observer ‚Äî TV</option>`,
    ...teamMembers.map(m=>`<option value="${esc(m.initials)}" ${u===m.initials?'selected':''}>${esc(m.name)} ‚Äî ${esc(m.initials)}</option>`)].join('');
  $('#idModal').classList.add('active');
}
function closeIdentityModal(){ $('#idModal').classList.remove('active'); }
function openPwModal(){ $('#pwModal').classList.add('active'); $('#pwMsg').textContent=''; $('#pwInput').value=''; }
function closePwModal(){ $('#pwModal').classList.remove('active'); }

function confirmIdentity(){
  const val = $('#idSelect').value.trim().toUpperCase();
  if(!val) return;
  if(val==='OBSERVER'){ setUser('OBSERVER'); closeIdentityModal(); renderCore(); ensureQr(); showView('team'); return; }
  if(val==='ZS'){ pendingZS = true; openPwModal(); return; }
  const rec = teamMembers.find(t=>t.initials===val); if(!rec) return;
  rec.status='present'; SYNC.saveTeam(teamMembers); setUser(val);
  closeIdentityModal(); renderCore(); ensureQr();
  showView(val==='KG' ? 'team' : 'vote');
}
/* ZS password flow */
function zsUnlock(){
  const pw = ($('#pwInput').value||'').trim();
  if(pw !== 'zsbf12'){ $('#pwMsg').textContent = 'Incorrect password.'; return; }
  const rec = teamMembers.find(t=>t.initials==='ZS'); if(rec){ rec.status='present'; SYNC.saveTeam(teamMembers); }
  setUser('ZS'); pendingZS=false; closePwModal(); closeIdentityModal(); renderCore(); ensureQr(); showView('admin');
}

/* PIN modal */
function openPinModal(){ $('#pinModal').classList.add('active'); $('#pinMsg').textContent=''; $('#pinInput').value=''; }
function closePinModal(){ $('#pinModal').classList.remove('active'); }
function checkPin(){ const entered = ($('#pinInput').value||'').trim(); if(!entered){ $('#pinMsg').textContent='Enter the PIN shown on the Team View.'; return; }
  if(entered === (sessionPin||'')){ localStorage.setItem(LS.pinok + sessionId, '1'); $('#pinMsg').textContent='Unlocked!'; closePinModal(); renderVote(); }
  else{ $('#pinMsg').textContent='Incorrect PIN. Try again.'; } }

/* Admin (ZS only) */
function renderAdmin(){
  if(getUser()!=='ZS'){ $('#view-admin').innerHTML = `<div class="panel"><h2>Admin</h2><p class="muted">Access denied. This section is visible only when you are ZS.</p></div>`; return; }
  $('#view-admin').innerHTML = `
    <h2>Admin</h2>
    <div class="sub">Visible only when you‚Äôre <strong>ZS</strong>.</div>
    <div class="grid cols-2">
      <div class="panel">
        <h3>Team Members</h3>
        <label for="teamArea">Format: <code>Full Name - XX</code> per line</label>
        <textarea id="teamArea" spellcheck="false"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn accent" id="saveTeam">Save Team</button>
          <button class="btn" id="resetSession">New Day</button>
        </div>
        <p class="muted" style="margin-top:8px">Clears votes & attendance; keeps the team list.</p>
        <div style="height:8px"></div>
        <label for="sessionInput">Session code</label>
        <div class="row">
          <input id="sessionInput" placeholder="e.g. fox123" />
          <button class="btn" id="saveSessionCode">Use code</button>
        </div>
        <p class="muted" style="margin-top:6px">QR updates automatically (Observer-only).</p>
      </div>
      <div class="panel">
        <h3>Attendance</h3>
        <div id="adminAttendance"></div>
        <div style="height:8px"></div>
        <div id="adminMsg" class="muted" style="margin-top:10px"></div>
      </div>
    </div>`;
  $('#teamArea').value = teamMembers.map(m=>`${m.name} - ${m.initials}`).join('\n');
  const tgt = $('#adminAttendance');
  tgt.innerHTML = teamMembers.map((m,i)=>`<label style="display:flex;align-items:center;gap:10px;margin:6px 0">
    <input type="checkbox" data-i="${i}" ${m.status==='present'?'checked':''}/> ${esc(m.name)} <span class="muted">(${esc(m.initials)})</span>
  </label>`).join('');
  tgt.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const i=+e.target.getAttribute('data-i'); teamMembers[i].status = e.target.checked?'present':'absent';
      SYNC.saveTeam(teamMembers); $('#adminMsg').textContent='Attendance updated.'; renderCore();
    });
  });
  $('#saveTeam').addEventListener('click', saveTeamFromArea);
  $('#resetSession').addEventListener('click', ()=>{ if(confirm('Start a new day? This clears votes and attendance.')){ SYNC.resetSessionAndAttendance(); $('#adminMsg').textContent='New day started (attendance cleared).'; } });
  $('#sessionInput').value = sessionId || '';
  $('#saveSessionCode').addEventListener('click', ()=>{ const val = ($('#sessionInput').value||'').trim(); if(!val){ alert('Enter a session code'); return; } SYNC.setSession(val); ensureQr(); renderVote(); $('#adminMsg').textContent='Session code set. Share the QR (Observer).'; });
  attachButtonTilt($('#view-admin'));
}
function saveTeamFromArea(){
  const arr=[]; for(const line of $('#teamArea').value.split('\n').map(x=>x.trim()).filter(Boolean)){ const m=line.match(/^(.+?)\s*-\s*([A-Za-z]{1,4})$/); if(m) arr.push({name:m[1].trim(), initials:m[2].toUpperCase(), status:'absent'}); }
  if(!arr.length){ alert('No valid lines. Use "Full Name - XX"'); return; }
  teamMembers=arr; SYNC.saveTeam(teamMembers);
  votes={}; votedInitials=[]; saveVotesLocal(votes); saveVotedLocal(votedInitials);
  $('#adminMsg').textContent='Team saved. Session reset (attendance cleared).'; SYNC.resetSessionAndAttendance(); renderCore(); ensureQr();
}

/* Fullscreen & sound toggle */
function toggleFullscreen(){ const doc=document; const el=document.documentElement; if(!doc.fullscreenElement){ el.requestFullscreen?.(); } else { doc.exitFullscreen?.(); } }
$('#fsToggle').addEventListener('click', toggleFullscreen);
$('#soundToggle').addEventListener('click', ()=>{
  const off = localStorage.getItem(LS.snd) === '0';
  localStorage.setItem(LS.snd, off ? '1' : '0');
  updateNav();
  if(off){ try{ ensureAudio().resume(); }catch{} }
});

/* Hash routes + nav */
window.addEventListener('hashchange', ()=>{ if(location.hash==='#view-vote') showView('vote'); else if(location.hash==='#view-admin') showView('admin'); else showView('team'); });
$$('nav .btn[data-view]').forEach(b=> b.addEventListener('click', e=> showView(e.target.getAttribute('data-view'))));

/* Buttons */
$('#btnStart').addEventListener('click', async ()=>{
  const btn = $('#btnStart');
  if(btn) btn.disabled = true;
  try{
    await ensurePromise(SYNC.setPhase('open'));
  }finally{
    renderMd();
  }
});
$('#btnReveal').addEventListener('click', async ()=>{
  const btn = $('#btnReveal');
  if(btn) btn.disabled = true;
  try{
    await ensurePromise(SYNC.triggerReveal());
  }finally{
    renderMd();
  }
});
$('#btnCloseReveal').addEventListener('click', async ()=>{
  const btn = $('#btnCloseReveal');
  if(btn) btn.disabled = true;
  try{
    await ensurePromise(SYNC.triggerReveal());
  }finally{
    renderMd();
  }
});
$('#openIdentity').addEventListener('click', openIdentityModal);
$('#clearIdentity').addEventListener('click', ()=>{ setUser(''); renderCore(); ensureQr(); });
$('#submitVote').addEventListener('click', voteSubmit);
$('#idCancel').addEventListener('click', closeIdentityModal);
$('#idOk').addEventListener('click', confirmIdentity);
$('#pwCancel').addEventListener('click', ()=>{ pendingZS=false; closePwModal(); });
$('#pwOk').addEventListener('click', zsUnlock);
$('#pinOk').addEventListener('click', checkPin);
$('#pinCancel').addEventListener('click', closePinModal);
$('#pinGenerate').addEventListener('click', ()=> SYNC.generatePin());
$('#pinEnable').addEventListener('change', (e)=> SYNC.setPinEnabled(e.target.checked));

/* Init */
(function init(){
  saveTeamLocal(teamMembers); saveVotesLocal(votes); saveVotedLocal(votedInitials);
  const qs = new URLSearchParams(location.search);
  if(qs.get('s')){ sessionId = qs.get('s'); localStorage.setItem(LS.session, sessionId); }
  if(window.BF_SYNC) window.BF_SYNC.sessionId = sessionId;
  SYNC.init();

  initAmbientMotion();
  initScrollDepth();
  attachButtonTilt(document);

  updateNav(); renderAll();
  if(location.hash==='#view-vote') showView('vote'); else if(location.hash==='#view-admin') showView('admin'); else showView('team');

  // Hide boot, then auto-prompt identity if not set
  setTimeout(()=>{
    const b=document.getElementById('boot');
    if(b){ b.classList.add('hide'); setTimeout(()=>b.remove(), 350); }
    if(!getUser()){ setTimeout(()=> openIdentityModal(), 250); }
  }, 16500);

  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
})();
</script>
</body>
</html>
